<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Peculiar Sequencer v18 (Ambient)</title>
    <style>
        :root {
            --bg: #050505;
            --app-bg: #0a0a0a;
            --surface: #141414;
            --primary: #9d4edd;
            --accent: #00bfa5;
            --text: #e0e0e0;
            --border: #2a2a2a;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg); color: var(--text);
            font-family: 'Inter', sans-serif; margin: 0; height: 100vh;
            display: flex; justify-content: center; align-items: center; overflow: hidden;
        }

        #app-frame {
            width: 100%; max-width: 480px; height: 100%; max-height: 90vh;
            background: var(--app-bg); display: flex; flex-direction: column;
            position: relative; border: 1px solid var(--border);
        }

        @media (min-width: 500px) { #app-frame { border-radius: 20px; } }

        /* Header */
        header {
            padding: 20px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(10,10,10,0.95);
        }
        h1 { font-size: 0.9rem; margin: 0; color: #666; letter-spacing: 2px; text-transform: uppercase; }
        #timer {
            font-family: monospace; font-size: 1.4rem; color: var(--primary);
            background: #1a1225; padding: 5px 12px; border-radius: 6px;
        }

        /* Timeline */
        main { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        
        .timeline-slot {
            display: flex; align-items: center; background: var(--surface);
            border: 1px solid var(--border); border-radius: 8px; padding: 5px;
            transition: all 0.3s ease;
        }
        .timeline-slot.active {
            border-color: var(--primary); background: #1a1225;
            box-shadow: 0 0 20px rgba(157, 78, 221, 0.15);
        }
        .time-badge {
            width: 60px; font-size: 0.7rem; color: #555; font-weight: bold;
            text-align: center; border-right: 1px solid #222; padding-right: 10px;
        }
        .drop-zone {
            flex: 1; height: 45px; display: flex; align-items: center; padding: 0 15px;
            font-size: 0.9rem; color: #444; margin-left: 5px;
        }
        .drop-zone.filled { color: #ccc; font-weight: 500; justify-content: space-between; }
        .remove-btn { color: #444; padding: 5px; cursor: pointer; }
        .remove-btn:hover { color: #ff4444; }

        /* Palette */
        #palette {
            padding: 15px; border-top: 1px solid var(--border); background: var(--app-bg);
            z-index: 10;
        }
        .palette-grid { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        
        .sound-chip {
            background: var(--surface); border: 1px solid var(--border);
            padding: 10px 16px; border-radius: 50px; font-size: 0.8rem; color: #888;
            cursor: grab; user-select: none; transition: all 0.2s;
        }
        .sound-chip:active { transform: scale(0.95); }
        .sound-chip.playing {
            background: #0f241a; border-color: var(--accent); color: var(--accent);
            box-shadow: 0 0 15px rgba(0, 191, 165, 0.2);
        }

        /* Footer */
        footer {
            padding: 15px; border-top: 1px solid var(--border); display: flex; gap: 10px;
            background: var(--app-bg);
        }
        .btn {
            flex: 1; padding: 16px; border-radius: 10px; border: none;
            font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 0.85rem;
            letter-spacing: 1px;
        }
        .btn-play { background: var(--primary); color: #fff; }
        .btn-stop { background: #221010; color: #ff5555; border: 1px solid #422; }
        .btn-clear { background: transparent; border: 1px solid #333; color: #666; max-width: 70px; }

        #overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 999;
            display: flex; justify-content: center; align-items: center;
        }
        #init-btn {
            padding: 20px 40px; background: var(--primary); color: #fff; border: none;
            border-radius: 50px; font-size: 1.2rem; cursor: pointer; font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="app-frame">
        <div id="overlay"><button id="init-btn">ENTER STUDIO</button></div>

        <header>
            <h1>PECULIAR SEQ</h1>
            <div id="timer">00:00</div>
        </header>

        <main id="timeline-area"></main>

        <div id="palette">
            <div style="text-align:center; color:#444; font-size:0.7rem; margin-bottom:10px; text-transform:uppercase; letter-spacing:1px;">Tap to Preview ‚Ä¢ Drag to Sequence</div>
            <div class="palette-grid">
                <div class="sound-chip" draggable="true" data-sound="mist">üå´Ô∏è Mist</div>
                <div class="sound-chip" draggable="true" data-sound="abyss">üåä Abyss</div>
                <div class="sound-chip" draggable="true" data-sound="womb">‚ù§Ô∏è Womb</div>
                <div class="sound-chip" draggable="true" data-sound="space">üåå Space</div>
                <div class="sound-chip" draggable="true" data-sound="dawn">‚òÄÔ∏è Dawn</div>
                <div class="sound-chip" draggable="true" data-sound="om">üïâÔ∏è Om</div>
                <div class="sound-chip" draggable="true" data-sound="silence">üîá Silence</div>
            </div>
        </div>

        <footer>
            <button class="btn btn-clear" onclick="sequencer.clear()">CLR</button>
            <button class="btn btn-play" onclick="sequencer.play()">PLAY</button>
            <button class="btn btn-stop" onclick="sequencer.stop(true)">STOP</button>
        </footer>
    </div>

    <script>
        /**
         * =====================================================================
         * AUDIO ENGINE v18 (Ambient/Drone Architecture)
         * =====================================================================
         */
        const audio = {
            ctx: null, master: null, 
            activeNodes: [], 
            previewNode: null, 
            previewSources: [],

            init() {
                if(this.ctx) return;
                const AC = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AC();
                this.master = this.ctx.createGain();
                this.master.gain.value = 0.7;
                // Master Compressor to glue drones together
                const comp = this.ctx.createDynamicsCompressor();
                comp.threshold.value = -20;
                comp.ratio.value = 10;
                this.master.connect(comp);
                comp.connect(this.ctx.destination);
                
                if(this.ctx.state === 'suspended') this.ctx.resume();
            },

            // --- SAFE FADE LOGIC (Fixed cut-off) ---
            safeFade(gainNode, duration, callback) {
                try {
                    const t = this.ctx.currentTime;
                    gainNode.gain.cancelScheduledValues(t);
                    gainNode.gain.setValueAtTime(gainNode.gain.value, t);
                    // Exponential ramp is better for audio, but can't hit 0. 
                    // Use setTargetAtTime for smooth physics decay.
                    gainNode.gain.setTargetAtTime(0, t, duration / 4); 
                    
                    setTimeout(() => {
                        if(callback) callback();
                    }, duration * 1000 + 200);
                } catch(e) { console.error(e); }
            },

            play(key) {
                this.stopAll(true); 
                if(key === 'silence') return;
                if(this.ctx.state === 'suspended') this.ctx.resume();

                const bus = this.ctx.createGain();
                bus.gain.value = 0;
                bus.connect(this.master);
                
                // Slow ambient fade in (4s)
                bus.gain.linearRampToValueAtTime(1, this.ctx.currentTime + 4);

                const sources = this.routeSound(key, bus);
                this.activeNodes.push({ sources: sources, bus: bus });
            },

            stopAll(fade=true) {
                this.stopPreview(); 
                const fadeTime = fade ? 5 : 0.1; // 5s Fade out
                
                this.activeNodes.forEach(item => {
                    this.safeFade(item.bus, fadeTime, () => {
                        item.sources.forEach(s => { try{s.stop()}catch(e){} });
                        try{item.bus.disconnect()}catch(e){}
                    });
                });
                this.activeNodes = [];
            },

            preview(key) {
                if(key === 'silence') return;
                this.stopPreview(); 

                const bus = this.ctx.createGain();
                bus.gain.value = 0;
                bus.connect(this.ctx.destination); 
                bus.gain.linearRampToValueAtTime(0.8, this.ctx.currentTime + 0.5);

                const sources = this.routeSound(key, bus);
                this.previewNode = bus;
                this.previewSources = sources;
            },

            stopPreview() {
                if(this.previewNode) {
                    const bus = this.previewNode;
                    const sources = this.previewSources;
                    
                    this.safeFade(bus, 0.8, () => {
                        sources.forEach(s => { try{s.stop()}catch(e){} });
                        try{bus.disconnect()}catch(e){}
                    });

                    this.previewNode = null;
                    this.previewSources = [];
                }
            },

            routeSound(key, dest) {
                switch(key) {
                    case 'mist': return this.genMist(dest);
                    case 'abyss': return this.genAbyss(dest);
                    case 'womb': return this.genWomb(dest);
                    case 'space': return this.genDrone(dest, [55,110], 'sine');
                    case 'dawn': return this.genDrone(dest, [130.8,196,261.6], 'triangle'); // Major
                    case 'om': return this.genOm(dest);
                    default: return [];
                }
            },

            // --- NEW AMBIENT GENERATORS ---
            
            genMist(dest) {
                // Replaces Rain.
                // Pink Noise + High Pass (1500Hz) = Airy "Hiss" Texture
                const bSize = this.ctx.sampleRate * 2;
                const b = this.ctx.createBuffer(1, bSize, this.ctx.sampleRate);
                const d = b.getChannelData(0);
                // Pink Noise Algo
                let b0=0,b1=0,b2=0,b3=0,b4=0,b5=0,b6=0;
                for(let i=0; i<bSize; i++) {
                    let white = Math.random() * 2 - 1;
                    b0 = 0.99886 * b0 + white * 0.0555179;
                    b1 = 0.99332 * b1 + white * 0.0750759;
                    b2 = 0.96900 * b2 + white * 0.1538520;
                    b3 = 0.86650 * b3 + white * 0.3104856;
                    b4 = 0.55000 * b4 + white * 0.5329522;
                    b5 = -0.7616 * b5 - white * 0.0168980;
                    d[i] = b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362;
                    d[i] *= 0.11; b6 = white * 0.115926;
                }
                
                const src = this.ctx.createBufferSource(); src.buffer = b; src.loop = true;
                
                // High Pass to remove all body, keeping only "air"
                const f = this.ctx.createBiquadFilter(); 
                f.type = 'highpass'; f.frequency.value = 1500; 
                
                // Very slow panning
                const pan = this.ctx.createStereoPanner();
                const lfo = this.ctx.createOscillator(); lfo.frequency.value = 0.05;
                const lfoG = this.ctx.createGain(); lfoG.gain.value = 0.3;
                lfo.connect(lfoG).connect(pan.pan);

                const g = this.ctx.createGain(); g.gain.value = 0.15; // Quiet

                src.connect(f).connect(pan).connect(g).connect(dest); 
                src.start(); lfo.start();
                return [src, lfo];
            },

            genAbyss(dest) {
                // Replaces Ocean.
                // Brown Noise + Low Pass (150Hz).
                // Pure deep rumble. No wind.
                const bSize = this.ctx.sampleRate * 2;
                const b = this.ctx.createBuffer(1, bSize, this.ctx.sampleRate);
                const d = b.getChannelData(0);
                let last=0;
                for(let i=0; i<bSize; i++) { 
                    let w=Math.random()*2-1; 
                    d[i]=(last+(0.02*w))/1.02; last=d[i]; d[i]*=3.5; 
                }
                
                const src = this.ctx.createBufferSource(); src.buffer=b; src.loop=true;
                const f = this.ctx.createBiquadFilter(); 
                f.type='lowpass'; f.frequency.value=150; // Deep submarine sound
                
                const g = this.ctx.createGain(); g.gain.value = 0.4;

                src.connect(f).connect(g).connect(dest); src.start();
                return [src];
            },

            genWomb(dest) {
                // Replaces Heart. Softer attack.
                const osc = this.ctx.createOscillator(); osc.frequency.value = 40; // Lower
                const g = this.ctx.createGain(); g.gain.value = 0;
                
                const lfo = this.ctx.createOscillator(); lfo.frequency.value = 1; // 60BPM
                // Sine wave LFO for smooth pulse, not on/off
                const lfoG = this.ctx.createGain(); lfoG.gain.value = 0.3;
                
                lfo.connect(lfoG).connect(g.gain);
                osc.connect(g).connect(dest);
                osc.start(); lfo.start();
                return [osc, lfo];
            },

            genDrone(dest, freqs, type) {
                let nodes = [];
                freqs.forEach(f => {
                    const o = this.ctx.createOscillator(); o.type = type; o.frequency.value = f;
                    const g = this.ctx.createGain(); g.gain.value = 0.06;
                    const p = this.ctx.createStereoPanner(); p.pan.value = Math.random()*0.5 - 0.25;
                    o.connect(g).connect(p).connect(dest); o.start();
                    nodes.push(o);
                });
                return nodes;
            },

            genOm(dest) {
                // Binaural Theta Drone (Replaces Theta)
                const o1 = this.ctx.createOscillator(); o1.frequency.value = 100;
                const p1 = this.ctx.createStereoPanner(); p1.pan.value = -0.8;
                const g1 = this.ctx.createGain(); g1.gain.value = 0.08;
                
                const o2 = this.ctx.createOscillator(); o2.frequency.value = 104; // 4Hz Theta
                const p2 = this.ctx.createStereoPanner(); p2.pan.value = 0.8;
                const g2 = this.ctx.createGain(); g2.gain.value = 0.08;

                o1.connect(g1).connect(p1).connect(dest);
                o2.connect(g2).connect(p2).connect(dest);
                o1.start(); o2.start();
                return [o1, o2];
            }
        };

        // --- SEQUENCER LOGIC ---
        const sequencer = {
            slots: [
                { min: 0, label: '0-10m', sound: null, soundLabel: '' },
                { min: 10, label: '10-20m', sound: null, soundLabel: '' },
                { min: 20, label: '20-30m', sound: null, soundLabel: '' },
                { min: 30, label: '30-40m', sound: null, soundLabel: '' },
                { min: 40, label: '40-50m', sound: null, soundLabel: '' },
                { min: 50, label: '50-60m', sound: null, soundLabel: '' }
            ],
            interval: null, startTime: 0, isPlaying: false,

            init() { this.load(); this.render(); this.bindPreview(); },

            bindPreview() {
                const chips = document.querySelectorAll('.sound-chip');
                chips.forEach(c => {
                    c.addEventListener('click', () => {
                        const sound = c.dataset.sound;
                        if(c.classList.contains('playing')) {
                            audio.stopPreview();
                            c.classList.remove('playing');
                        } else {
                            document.querySelectorAll('.sound-chip').forEach(sc => sc.classList.remove('playing'));
                            audio.preview(sound);
                            c.classList.add('playing');
                        }
                    });
                    c.addEventListener('dragstart', () => {
                        audio.stopPreview();
                        document.querySelectorAll('.sound-chip').forEach(sc => sc.classList.remove('playing'));
                    });
                });
            },

            updateSlot(idx, sound, label) {
                this.slots[idx].sound = sound; this.slots[idx].soundLabel = label;
                this.save(); this.render();
            },

            render() {
                const area = document.getElementById('timeline-area');
                area.innerHTML = ''; 
                this.slots.forEach((slot, i) => {
                    const html = `
                    <div class="timeline-slot" id="slot-${i}">
                        <div class="time-badge">${slot.label}</div>
                        <div class="drop-zone ${slot.sound ? 'filled' : ''}" data-idx="${i}">
                            ${slot.sound ? `<span>${slot.soundLabel}</span><span class="remove-btn" onclick="sequencer.clearSlot(${i})">‚úï</span>` : ''}
                        </div>
                    </div>`;
                    area.insertAdjacentHTML('beforeend', html);
                });
                this.bindDrag();
            },

            bindDrag() {
                const chips = document.querySelectorAll('.sound-chip');
                const zones = document.querySelectorAll('.drop-zone');
                chips.forEach(c => {
                    c.addEventListener('dragstart', e => {
                        e.dataTransfer.setData('sound', e.target.dataset.sound);
                        e.dataTransfer.setData('label', e.target.innerText);
                    });
                });
                zones.forEach(z => {
                    z.addEventListener('dragover', e => { e.preventDefault(); });
                    z.addEventListener('drop', e => {
                        e.preventDefault();
                        const sound = e.dataTransfer.getData('sound');
                        const label = e.dataTransfer.getData('label');
                        if(sound) this.updateSlot(z.dataset.idx, sound, label);
                    });
                });
            },

            clearSlot(idx) { this.updateSlot(idx, null, ''); },
            clear() { this.slots.forEach(s => {s.sound=null; s.soundLabel='';}); this.save(); this.render(); },
            save() { localStorage.setItem('peculiar_v18', JSON.stringify(this.slots)); },
            load() { const d = localStorage.getItem('peculiar_v18'); if(d) this.slots = JSON.parse(d); },

            play() {
                if(this.isPlaying) this.stop(false); 
                this.isPlaying = true;
                
                audio.init(); 
                this.startTime = Date.now();
                
                if(this.slots[0].sound) audio.play(this.slots[0].sound);
                this.highlight(0);

                this.interval = setInterval(() => {
                    const elapsed = (Date.now() - this.startTime) / 1000;
                    const mins = elapsed / 60;
                    const m = Math.floor(mins).toString().padStart(2,'0');
                    const s = Math.floor(elapsed % 60).toString().padStart(2,'0');
                    document.getElementById('timer').innerText = `${m}:${s}`;

                    for(let i=this.slots.length-1; i>=0; i--) {
                        if(mins >= this.slots[i].min) {
                            const el = document.getElementById(`slot-${i}`);
                            if(!el.classList.contains('active')) {
                                this.highlight(i);
                                if(this.slots[i].sound) audio.play(this.slots[i].sound);
                                else audio.stopAll(true);
                            }
                            break;
                        }
                    }
                }, 1000);
            },

            stop(fade=true) {
                this.isPlaying = false;
                clearInterval(this.interval);
                audio.stopAll(fade);
                document.querySelectorAll('.timeline-slot').forEach(e => e.classList.remove('active'));
                document.getElementById('timer').innerText = "00:00";
            },

            highlight(idx) {
                document.querySelectorAll('.timeline-slot').forEach(e => e.classList.remove('active'));
                document.getElementById(`slot-${idx}`).classList.add('active');
            }
        };

        document.getElementById('init-btn').addEventListener('click', () => {
            audio.init();
            sequencer.init();
            document.getElementById('overlay').style.display = 'none';
        });
    </script>
</body>
</html>
