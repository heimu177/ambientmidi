<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asana Meridian Analyzer (Resizble Text)</title>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
<style>
  /* DARCULA THEME */
  :root { --bg-dark: #2b2b2b; --bg-panel: #3c3f41; --bg-input: #45494a; --text-main: #a9b7c6; --text-accent: #cc7832; --border: #555; --green: #6a8759; }
  body, html { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg-dark); color: var(--text-main); height: 100vh; overflow: hidden; }
  #app { display: flex; height: 100%; }

  /* VIEWER */
  #viewer-container { flex: 1; display: flex; flex-direction: column; background: #1e1e1e; overflow: hidden; }
  
  #toolbar { 
    height: 50px; background: #2a2a2a; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; gap: 15px;
  }
  
  #viewer { flex: 1; display: flex; justify-content: center; align-items: center; padding: 20px; position: relative; overflow: hidden; }
  
  canvas { max-width: 100%; max-height: 100%; box-shadow: 0 0 20px rgba(0,0,0,0.5); border-radius: 4px; transition: filter 0.1s; }
  
  /* TOOLBAR CONTROLS */
  .toggle-btn {
    background: #444; color: #aaa; border: 1px solid #666; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; user-select: none;
  }
  .toggle-btn.active { background: var(--text-accent); color: #fff; border-color: var(--text-accent); }
  
  .slider-group { display: flex; align-items: center; gap: 10px; font-size: 12px; color: #888; border-left: 1px solid #444; padding-left: 15px; }
  input[type=range] { width: 80px; accent-color: var(--text-accent); }

  /* SIDEBAR */
  #sidebar { width: 420px; background: var(--bg-panel); border-left: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; overflow-y: auto; box-shadow: -5px 0 20px rgba(0,0,0,0.3); }
  h1 { margin: 0 0 20px 0; color: var(--text-accent); font-size: 20px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid var(--border); padding-bottom: 10px; }
  h2 { margin: 20px 0 10px 0; font-size: 14px; color: var(--text-main); font-weight: bold; text-transform: uppercase; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
  
  .input-group { margin-bottom: 15px; }
  label { display: block; font-size: 12px; color: #808080; margin-bottom: 5px; font-weight:bold; }
  input[type="text"] { width: 100%; padding: 10px; background: var(--bg-input); border: 1px solid var(--border); color: #fff; border-radius: 4px; font-size: 14px; }
  
  #drop-zone { border: 2px dashed var(--border); padding: 20px; text-align: center; color: #888; cursor: pointer; border-radius: 6px; margin-bottom: 10px; }
  #drop-zone:hover { border-color: var(--text-accent); color: var(--text-accent); background: rgba(255,255,255,0.05); }

  #meridian-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .meridian-row { display: flex; align-items: center; margin-bottom: 4px; }
  .m-label { width: 30px; font-size: 11px; font-weight: bold; color: #bbb; }
  .m-track { flex: 1; height: 6px; background: #222; border-radius: 3px; overflow: hidden; }
  .m-fill { height: 100%; border-radius: 3px; width: 0%; }
  .m-val { width: 30px; text-align: right; font-size: 10px; color: #888; margin-left: 5px; }
  
  #muscle-tags { display: flex; flex-wrap: wrap; gap: 5px; min-height: 20px; }
  .tag { background: #222; border: 1px solid #555; color: var(--green); padding: 3px 8px; border-radius: 4px; font-size: 11px; }

  button.main-btn { width: 100%; padding: 12px; margin-top: 10px; background: #4a88c7; color: #fff; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
  button.main-btn:hover { background: #3a70a8; }
  
  #json-preview { font-family: 'Consolas', monospace; font-size: 10px; background: #222; color: #a9b7c6; padding: 10px; border-radius: 4px; height: 80px; overflow-y: auto; border: 1px solid var(--border); }
</style>
</head>
<body>

<div id="app">
  
  <div id="viewer-container">
    <!-- TOOLBAR -->
    <div id="toolbar">
      <div class="toggle-btn active" id="btn-skeleton" onclick="toggle('skeleton')">Skeleton</div>
      <div class="toggle-btn active" id="btn-muscles" onclick="toggle('muscles')">Muscle Labels</div>
      <div class="toggle-btn active" id="btn-meridians" onclick="toggle('meridians')">Meridian Lines</div>
      
      <div class="slider-group">
        <span>Image Brightness</span>
        <input type="range" min="0" max="100" value="100" oninput="adjustBrightness(this.value)">
      </div>
      
      <!-- NEW: Text Size Slider -->
      <div class="slider-group">
        <span>Text Size</span>
        <input type="range" min="12" max="40" value="18" oninput="adjustTextSize(this.value)">
      </div>
    </div>

    <div id="viewer">
      <canvas id="output"></canvas>
      <div id="placeholder-text" style="color:#555; position:absolute;">Upload Image</div>
    </div>
  </div>

  <div id="sidebar">
    <h1>Asana Analyzer</h1>
    <div id="drop-zone" onclick="document.getElementById('fileInput').click()">
      Click to Upload Photo
      <input type="file" id="fileInput" accept="image/*" style="display:none">
    </div>
    <div class="input-group"><label>POSE NAME</label><input type="text" id="poseName" placeholder="e.g., Downward Dog"></div>
    <h2>Meridian Profile</h2><div id="meridian-grid"></div>
    <h2>Active Muscles</h2><div id="muscle-tags"><span style="color:#555; font-size:12px;">--</span></div>
    <h2>Export</h2><div id="json-preview">// JSON Data...</div>
    <button class="main-btn" onclick="downloadJSON()">Save Asana Card</button>
  </div>
</div>

<script>
const canvas = document.getElementById('output');
const ctx = canvas.getContext('2d');
const fileInput = document.getElementById('fileInput');
const jsonPreview = document.getElementById('json-preview');
const muscleTagsDiv = document.getElementById('muscle-tags');
const meridianGrid = document.getElementById('meridian-grid');
const poseNameInput = document.getElementById('poseName');
const placeholder = document.getElementById('placeholder-text');

let currentAnalysis = null;
let poseEstimator = null;
let currentImage = null; 
let lastResults = null;

// UI STATE
const show = { skeleton: true, muscles: true, meridians: true };
let brightness = 100;
let fontSize = 18; // User adjustable

const MERIDIANS = [
  {id:'LU', name:'LU', color:'#fff', muscles:['Pectoralis', 'Biceps'], anchor: 11}, 
  {id:'LI', name:'LI', color:'#ccc', muscles:['Deltoid', 'Triceps'], anchor: 13}, 
  {id:'ST', name:'ST', color:'#fc0', muscles:['Quadriceps'], anchor: 23}, 
  {id:'SP', name:'SP', color:'#f90', muscles:['Adductors', 'Abs'], anchor: 23},
  {id:'HT', name:'HT', color:'#f00', muscles:['Pec Minor'], anchor: 11},
  {id:'SI', name:'SI', color:'#f55', muscles:['Trapezius', 'Scapula'], anchor: 12},
  {id:'BL', name:'BL', color:'#06f', muscles:['Hamstrings', 'Calves'], anchor: 25}, 
  {id:'KD', name:'KD', color:'#00f', muscles:['Soleus'], anchor: 27}, 
  {id:'PC', name:'PC', color:'#f0a', muscles:['Chest'], anchor: 12},
  {id:'TB', name:'TB', color:'#ff0', muscles:['Deltoid'], anchor: 14},
  {id:'GB', name:'GB', color:'#0f0', muscles:['IT Band', 'Glutes'], anchor: 23},
  {id:'LV', name:'LV', color:'#393', muscles:['Deep Core'], anchor: 24},
  {id:'GV', name:'GV', color:'#eee', muscles:['Spine'], anchor: 0}, 
  {id:'CV', name:'CV', color:'#888', muscles:['Rectus Abs'], anchor: 24}
];

function initUI() {
  meridianGrid.innerHTML = '';
  MERIDIANS.forEach(m => {
    meridianGrid.innerHTML += `
      <div class="meridian-row">
        <div class="m-label" style="color:${m.color}">${m.name}</div>
        <div class="m-track"><div class="m-fill" id="bar-${m.id}" style="background:${m.color}"></div></div>
        <div class="m-val" id="val-${m.id}">0%</div>
      </div>`;
  });
}
initUI();

function toggle(layer) {
  show[layer] = !show[layer];
  document.getElementById(`btn-${layer}`).classList.toggle('active');
  if(lastResults) drawFrame(lastResults);
}

function adjustBrightness(val) {
  brightness = val;
  if(lastResults) drawFrame(lastResults);
}

function adjustTextSize(val) {
  fontSize = parseInt(val);
  if(lastResults) drawFrame(lastResults);
}

async function processImage(imgElement) {
  if (poseEstimator) await poseEstimator.close();
  poseEstimator = new Pose({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`});
  poseEstimator.setOptions({ modelComplexity: 1, smoothLandmarks: true });
  poseEstimator.onResults((results) => {
    lastResults = results;
    canvas.width = imgElement.naturalWidth;
    canvas.height = imgElement.naturalHeight;
    drawFrame(results);
    
    if(results.poseLandmarks) {
      const analysis = analyzePose(results.poseLandmarks);
      currentAnalysis = { timestamp: new Date().toISOString(), data: analysis };
      updateSidebar(analysis);
      updateJSON();
    }
  });
  await poseEstimator.send({image: imgElement});
}

function drawFrame(results) {
  if(!currentImage) return;
  
  // 1. Draw Base Image
  ctx.filter = `brightness(${brightness}%)`;
  ctx.drawImage(currentImage, 0, 0);
  ctx.filter = 'none';

  if (!results.poseLandmarks) return;
  const pose = results.poseLandmarks;

  // 2. Draw Skeleton
  if(show.skeleton) {
    drawConnectors(ctx, pose, POSE_CONNECTIONS, {color:'rgba(255,255,255,0.5)', lineWidth:8});
    drawLandmarks(ctx, pose, {color:'#00d2ff', lineWidth:3, radius:6});
  }

  // 3. Draw Meridian Lines
  if(show.meridians) {
    ctx.shadowBlur = 20; 
    drawNeonLine(pose[11], pose[13], '#00d2ff'); 
    drawNeonLine(pose[12], pose[14], '#00d2ff');
    drawNeonLine(pose[23], pose[25], '#00ff00'); 
    drawNeonLine(pose[24], pose[26], '#00ff00');
    drawNeonLine(pose[11], pose[23], '#ffaa00'); 
    drawNeonLine(pose[12], pose[24], '#ffaa00');
    ctx.shadowBlur = 0;
  }

  // 4. Draw Adjustable Text
  if(show.muscles && currentAnalysis) {
    const drawnAnchors = new Set();
    MERIDIANS.forEach(m => {
      if(currentAnalysis.data.meridians[m.id] > 60) {
        const anchorIdx = m.anchor;
        const anchorPoint = pose[anchorIdx];
        if(anchorPoint && !drawnAnchors.has(anchorIdx)) {
          drawnAnchors.add(anchorIdx);
          const x = anchorPoint.x * canvas.width;
          const y = anchorPoint.y * canvas.height;
          const offset = (anchorPoint.x > 0.5) ? 30 : -180; 
          
          // Responsive Box Width based on font size
          const boxW = fontSize * 8; 
          const boxH = fontSize * 1.8;

          ctx.fillStyle = "rgba(0,0,0,0.9)";
          ctx.fillRect(x + offset, y - (boxH/2), boxW, boxH);
          
          ctx.fillStyle = m.color;
          ctx.font = `bold ${fontSize}px Arial`;
          ctx.fillText(m.muscles[0], x + offset + 10, y + (fontSize/3));
          
          ctx.beginPath();
          ctx.moveTo(x, y);
          ctx.lineTo(x + offset + (offset > 0 ? 0 : boxW), y);
          ctx.strokeStyle = m.color;
          ctx.lineWidth = 2;
          ctx.stroke();
          
          ctx.beginPath();
          ctx.arc(x, y, 6, 0, 2*Math.PI);
          ctx.fillStyle = m.color;
          ctx.fill();
        }
      }
    });
  }
}

function drawNeonLine(p1, p2, color) {
  ctx.beginPath();
  ctx.moveTo(p1.x * canvas.width, p1.y * canvas.height);
  ctx.lineTo(p2.x * canvas.width, p2.y * canvas.height);
  ctx.strokeStyle = color;
  ctx.shadowColor = color;
  ctx.lineWidth = 6; // Thicker Lines
  ctx.stroke();
}

fileInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if(!file) return;
  placeholder.style.display = 'none';
  const reader = new FileReader();
  reader.onload = (ev) => {
    const img = new Image();
    img.onload = () => { currentImage = img; processImage(img); };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
  fileInput.value = ''; 
});

function analyzePose(pose) {
  const v = {}; 
  const ang = (a,b,c) => {
    if(!pose[a] || !pose[b] || !pose[c]) return 0;
    const rad = Math.atan2(pose[c].y-pose[b].y, pose[c].x-pose[b].x) - Math.atan2(pose[a].y-pose[b].y, pose[a].x-pose[b].x);
    return Math.abs(rad * 180/Math.PI);
  };

  const lElbow = ang(11,13,15); const rElbow = ang(12,14,16);
  v.LU = map((lElbow + rElbow)/2, 90, 180, 30, 90); v.HT = map(pose[15].y, pose[11].y, pose[0].y, 20, 100);
  v.PC = (v.LU + v.HT) / 2; v.LI = 100 - v.LU; v.SI = 100 - v.HT; v.TB = 100 - v.PC;
  const hipFlex = ang(11,23,25); v.ST = map(hipFlex, 180, 90, 20, 100); v.SP = v.ST * 1.1;
  const isFold = pose[0].y > pose[23].y; v.BL = isFold ? 95 : 30;
  const width = Math.abs(pose[27].x - pose[28].x); v.KD = map(width, 0.1, 0.5, 20, 100);
  v.LV = v.KD * 0.9 + (isFold ? 20 : 0); const tilt = Math.abs(pose[11].y - pose[12].y);
  v.GB = map(tilt, 0, 0.2, 10, 100); v.GV = (hipFlex > 190) ? 90 : 40; v.CV = (hipFlex < 160) ? 80 : 30;
  const muscles = new Set(); MERIDIANS.forEach(m => { if(v[m.id] > 60) m.muscles.forEach(mus => muscles.add(mus)); });
  return { meridians: v, activeMuscles: Array.from(muscles) };
}

function updateSidebar(data) {
  for(const [k, val] of Object.entries(data.meridians)) {
    document.getElementById(`bar-${k}`).style.width = val + '%';
    document.getElementById(`val-${k}`).textContent = Math.round(val) + '%';
  }
  muscleTagsDiv.innerHTML = '';
  data.activeMuscles.forEach(m => muscleTagsDiv.innerHTML += `<span class="tag">${m}</span>`);
}

function updateJSON() {
  if(!currentAnalysis) return;
  const exportData = { name: poseNameInput.value, ...currentAnalysis };
  jsonPreview.textContent = JSON.stringify(exportData, null, 2);
}

function map(val, s1, e1, s2, e2) { return Math.min(e2, Math.max(s2, s2 + (e2 - s2) * ((val - s1) / (e1 - s1)))); }

function downloadJSON() {
  if(!currentAnalysis) return alert("No data!");
  updateJSON();
  const blob = new Blob([jsonPreview.textContent], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = (poseNameInput.value||'pose')+".json";
  a.click();
}
poseNameInput.addEventListener('input', updateJSON);
</script>
</body>
</html>
