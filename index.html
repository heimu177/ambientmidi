<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Obsidian Pan v8 | Multi-Scale Handpan (Mobile-Optimized)</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #121215;
            --panel-bg: #1e1e24;
            --pan-body-dark: #2c2c36;
            --pan-body-light: #444450;
            --note-field-base: rgba(0, 0, 0, 0.4);
            --note-text-color: #bbbbbb;
            --accent-blue: #0088cc;
            --accent-gold: #d4af37;
            --label-text: #888888;
            --slider-track: #333333;
            --slider-thumb: #555555;
        }

        body {
            background-color: var(--bg-color);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Montserrat', sans-serif;
            overflow: hidden;
            touch-action: none;
            user-select: none;
            color: var(--label-text);
        }

        /* --- START OVERLAY --- */
        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; font-size: 1.1rem;
            transition: opacity 0.5s ease-out;
        }
        #start-overlay h2 { margin-bottom: 30px; font-weight: 300; letter-spacing: 4px; color: var(--accent-blue); }
        #start-btn {
            background: var(--accent-blue); color: white;
            border: none; padding: 15px 30px; border-radius: 5px;
            font-family: inherit; font-size: 1rem; cursor: pointer;
            transition: background 0.2s;
        }
        #start-btn:hover { background: #0056b3; }

        /* --- MAIN CONTAINER --- */
        .pan-wrapper {
            display: flex; flex-direction: column; align-items: center;
            gap: 40px;
            transform: scale(0.95);
            max-width: 900px;
        }

        /* --- HANDPAN VISUAL --- */
        .handpan-container {
            position: relative;
            width: 400px; height: 400px;
            background: radial-gradient(circle at 35% 35%, var(--pan-body-light), var(--pan-body-dark) 80%);
            border-radius: 50%;
            box-shadow: 0 15px 50px rgba(0,0,0,0.8), inset 0 0 50px rgba(0,0,0,0.6);
            display: flex; justify-content: center; align-items: center;
        }
        .note-field {
            position: absolute;
            background-color: var(--note-field-base);
            border-radius: 50%;
            box-shadow: inset 0 5px 10px rgba(0,0,0,0.8), 0 0 5px rgba(0,0,0,0.5);
            cursor: pointer;
            transition: transform 0.1s ease-out, box-shadow 0.1s ease-out;
            display: flex; justify-content: center; align-items: center;
            font-size: 0.85rem;
            font-weight: 400;
            color: var(--note-text-color);
        }
        .note-field.active {
            transform: scale(0.95);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.9), 0 0 15px var(--accent-blue), 0 0 25px rgba(0,136,204,0.4);
        }
        .ding-note { width: 100px; height: 100px; }
        .outer-note { width: 70px; height: 70px; }


        /* --- CONTROL PANEL (New Layout) --- */
        .control-panel {
            background-color: var(--panel-bg);
            border-radius: 15px;
            padding: 20px 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 700px;
        }

        /* --- SLIDERS --- */
        .slider-group {
            display: flex;
            justify-content: space-around;
            gap: 30px;
            padding: 10px 0;
            border-bottom: 1px solid #333;
        }
        .slider-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .slider-container label {
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 1px;
            margin-bottom: 8px;
            color: var(--accent-gold);
        }
        .slider-label-value {
             font-size: 0.8rem;
             color: var(--label-text);
             margin-top: 5px;
        }
        .control-slider {
            -webkit-appearance: none;
            width: 90%;
            height: 8px;
            background: var(--slider-track);
            border-radius: 4px;
            outline: none;
            transition: opacity .2s;
        }
        .control-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-blue);
            cursor: pointer;
            border: 2px solid var(--panel-bg);
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        /* --- SCALE BUTTONS --- */
        .scale-buttons-group { 
            display: flex;
            justify-content: space-around;
            gap: 10px;
            padding: 10px 0;
            flex-wrap: wrap; 
        }
        .scale-btn { 
            flex-basis: calc(20% - 10px); 
            padding: 10px 8px;
            border-radius: 8px;
            background: #282830;
            color: var(--label-text);
            border: 1px solid #444;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            text-align: center;
            transition: background 0.1s, border-color 0.1s, color 0.1s;
        }
        .scale-btn.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
            box-shadow: 0 0 8px rgba(0,136,204,0.5);
        }

        /* --- UTILITY BUTTONS --- */
        .utility-buttons {
            display: flex;
            gap: 15px;
            padding-top: 10px;
        }
        .utility-btn {
            width: 40px; height: 40px; border-radius: 50%;
            background: #282830;
            border: 1px solid #333;
            color: var(--label-text);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
            transition: background 0.1s;
        }
        .utility-btn.power svg, .utility-btn.bluetooth svg { width: 18px; height: 18px; fill: currentColor; }
        .utility-btn.power.active { color: var(--accent-gold); box-shadow: 0 0 10px var(--accent-gold); }
    </style>
</head>
<body>

    <div id="start-overlay">
        <h2>OBSIDIAN PAN v8</h2>
        <button id="start-btn">Begin Soundscape</button>
    </div>

    <div class="pan-wrapper">
        
        <div class="control-panel">
            
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="utility-buttons">
                    <div class="utility-btn power" id="power-btn">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M13 3C13 2.44772 12.5523 2 12 2C11.4477 2 11 2.44772 11 3V11C11 11.5523 11.4477 12 12 12C12.5523 12 13 11.5523 13 11V3Z"/>
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20Z"/>
                        </svg>
                    </div>
                    <div class="utility-btn bluetooth" id="bluetooth-btn">
                         <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M7 17L17 7L12 2V22L17 17L7 7L12 12L7 17Z"/>
                        </svg>
                    </div>
                </div>
                <h3 style="color: var(--accent-blue); font-weight: 400; letter-spacing: 2px;">EFFECTS MIXER</h3>
            </div>

            <div class="slider-group">
                <div class="slider-container">
                    <label for="volume-slider">Volume</label>
                    <input type="range" min="0" max="1" step="0.01" value="0.5" class="control-slider" id="volume-slider">
                    <span class="slider-label-value" id="volume-val">0.50</span>
                </div>
                <div class="slider-container">
                    <label for="reverb-slider">Reverb Send (0-100%)</label>
                    <input type="range" min="0" max="1" step="0.01" value="0.0" class="control-slider" id="reverb-slider">
                    <span class="slider-label-value" id="reverb-val">0.00</span>
                </div>
                <div class="slider-container">
                    <label for="delay-slider">Delay Send (0-80%)</label>
                    <input type="range" min="0" max="0.8" step="0.01" value="0.0" class="control-slider" id="delay-slider">
                    <span class="slider-label-value" id="delay-val">0.00</span>
                </div>
            </div>

            <h3 style="color: var(--accent-gold); font-weight: 400; letter-spacing: 2px; text-align: center; margin-bottom: 5px;">SCALE SELECTION</h3>
            <div class="scale-buttons-group" id="scale-selector">
                <button class="scale-btn active" data-scale-index="0">D Minor (Amara)</button>
                <button class="scale-btn" data-scale-index="1">C Major (Ionian)</button>
                <button class="scale-btn" data-scale-index="2">F Lydian (Dream)</button>
                <button class="scale-btn" data-scale-index="3">E Minor Pent.</button>
                <button class="scale-btn" data-scale-index="4">A Harmonic Minor</button>
            </div>
        </div>
        
        <div class="handpan-container" id="handpan-visual">
        </div>
    </div>

    <script>
        // --- AUDIO CORE SETUP ---
        let audioCtx;
        let isAudioInitialized = false;
        let masterGain, masterCompressor, masterLimiter;
        let dryGain; 
        let globalReverb, globalDelayL, globalDelayR, globalDelayFeedback; 
        
        // --- DEFAULT PARAMETERS (Startup state) ---
        const DEFAULT_PARAMS = {
            volume: 0.5,
            reverb: 0.0,
            delay: 0.0,
            scale: 0, // Default to D Minor
            power: false
        };

        // --- UI & PARAMETERS ---
        const startButton = document.getElementById('start-btn');
        const powerButton = document.getElementById('power-btn');
        const handpanVisual = document.getElementById('handpan-visual');
        const scaleSelector = document.getElementById('scale-selector');

        const sliders = {
            volume: document.getElementById('volume-slider'),
            reverb: document.getElementById('reverb-slider'),
            delay: document.getElementById('delay-slider')
        };
        const sliderVals = {
             volume: document.getElementById('volume-val'),
             reverb: document.getElementById('reverb-val'),
             delay: document.getElementById('delay-val')
        };

        let currentParams = { ...DEFAULT_PARAMS }; 

        // --- SCALE DEFINITIONS ---
        // Frequencies are in Hertz (Hz). 
        // Format: [Ding Note, Note 1, Note 2, Note 3, Note 4, Note 5, Note 6, Note 7] (8 notes total)
        const NOTE_FREQUENCIES = {
            // D Minor (D3, A3, C4, D4, E4, F4, G4, A4) 
            0: [146.83, 220.00, 261.63, 293.66, 329.63, 349.23, 392.00, 440.00],
            // C Major (C3, G3, A3, C4, D4, E4, F4, G4) 
            1: [130.81, 196.00, 220.00, 261.63, 293.66, 329.63, 349.23, 392.00],
            // F Lydian (F3, C4, D4, E4, F4, G4, A4, B4) 
            2: [174.61, 261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88],
            // E Minor Pentatonic (E3, A3, B3, D4, E4, G4, A4, B4) 
            3: [164.81, 220.00, 246.94, 293.66, 329.63, 392.00, 440.00, 493.88],
            // A Harmonic Minor (A3, C4, D4, E4, F4, G#4, A4, B4) 
            4: [220.00, 261.63, 293.66, 329.63, 349.23, 415.30, 440.00, 493.88]
        };
        
        const NOTE_NAMES_D_MINOR = ["D3", "A3", "C4", "D4", "E4", "F4", "G4", "A4"];
        
        // --- INITIALIZATION ---
        startButton.addEventListener('click', async () => {
            if (isAudioInitialized) return;
            try {
                // Initialize Audio Context (Crucial for iOS/Mobile)
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                await audioCtx.resume();
                
                initAudioGraph();
                initSliderInteractions();
                initScaleButtonInteractions();

                // Generate notes based on the default scale (D Minor)
                generateHandpanNotes(NOTE_FREQUENCIES[DEFAULT_PARAMS.scale]); 

                resetUIAndParams(); 

                // Hide overlay after successful initialization
                document.getElementById('start-overlay').style.opacity = 0;
                setTimeout(() => document.getElementById('start-overlay').style.display = 'none', 500);
                isAudioInitialized = true;
            } catch (e) {
                alert("Audio failed to start. Error: " + e.message);
                console.error("Audio Init Error:", e);
            }
        });


        function resetUIAndParams() {
            currentParams = { ...DEFAULT_PARAMS };
            currentParams.power = true; 

            // Update sliders
            Object.keys(sliders).forEach(key => {
                sliders[key].value = DEFAULT_PARAMS[key];
                sliderVals[key].textContent = DEFAULT_PARAMS[key].toFixed(2);
            });

            // Update scale buttons
            document.querySelectorAll('#scale-selector .scale-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`#scale-selector .scale-btn[data-scale-index="${DEFAULT_PARAMS.scale}"]`).classList.add('active');
            
            powerButton.classList.add('active');
            
            if (isAudioInitialized) {
                updateMasterGains(); 
                updateDelayParams();
                audioCtx.resume();
            }
        }
        
        function initAudioGraph() {
            // Master Gain
            masterGain = audioCtx.createGain();
            masterGain.gain.value = currentParams.volume;

            // Compressor & Limiter (Safety chain)
            masterCompressor = audioCtx.createDynamicsCompressor();
            masterCompressor.threshold.value = -10; 
            masterCompressor.ratio.value = 8;
            
            masterLimiter = audioCtx.createDynamicsCompressor();
            masterLimiter.threshold.value = -3; 
            masterLimiter.ratio.value = 20; 
            masterLimiter.attack.value = 0.001;
            masterLimiter.release.value = 0.1;
            
            // Final connection chain
            masterGain.connect(masterCompressor).connect(masterLimiter).connect(audioCtx.destination);

            // --- SEND/RETURN Busses ---
            dryGain = audioCtx.createGain(); 
            dryGain.connect(masterGain); 

            // Global Reverb (Convolution)
            globalReverb = audioCtx.createConvolver();
            globalReverb.buffer = createReverbImpulse(4.0);
            globalReverb.connect(masterGain); 

            // Global Stereo Ping-Pong Delay
            globalDelayL = audioCtx.createDelay(1.5);
            globalDelayR = audioCtx.createDelay(1.5);
            globalDelayFeedback = audioCtx.createGain();

            globalDelayL.connect(masterGain); 
            globalDelayR.connect(masterGain); 

            // Feedback Loop (MAX STABLE GAIN)
            globalDelayL.connect(globalDelayFeedback); 
            globalDelayR.connect(globalDelayFeedback);
            globalDelayFeedback.connect(globalDelayL);
        }

        function createReverbImpulse(duration) {
            const rate = audioCtx.sampleRate;
            const len = rate * duration;
            const buff = audioCtx.createBuffer(2, len, rate);
            for (let i = 0; i < len; i++) {
                const d = Math.pow(1 - i / len, 2.0);
                buff.getChannelData(0)[i] = (Math.random() * 2 - 1) * d * 0.4;
                buff.getChannelData(1)[i] = (Math.random() * 2 - 1) * d * 0.4;
            }
            return buff;
        }

        // --- AUDIO PARAMETER UPDATES ---
        function updateMasterGains() {
            if (!isAudioInitialized) return;
            const now = audioCtx.currentTime;

            // 1. Master Volume
            masterGain.gain.setTargetAtTime(currentParams.volume, now, 0.05);

            // 2. Dry signal dampening when effects are high
            const totalWet = currentParams.reverb + currentParams.delay;
            dryGain.gain.setTargetAtTime(1.0 - (totalWet * 0.35), now, 0.1);
        }

        function updateDelayParams() {
             if (!isAudioInitialized) return;
             const now = audioCtx.currentTime;

            // Fixed feedback gain to ensure stability (0.4 max)
            const maxStableFeedback = 0.4; 
            globalDelayFeedback.gain.setTargetAtTime(maxStableFeedback, now, 0.1); 

            globalDelayL.delayTime.value = 0.3; 
            globalDelayR.delayTime.value = 0.5;
        }

        // --- SYNTHESIS ENGINE (HANDPAN) ---
        function triggerNote(freq) {
            if (!isAudioInitialized || !currentParams.power) return;
            const now = audioCtx.currentTime;

            const masterVoiceGain = audioCtx.createGain();
            
            // Gain nodes to control the send amount for each voice
            const reverbVoiceSend = audioCtx.createGain();
            reverbVoiceSend.gain.value = currentParams.reverb; 
            
            const delayVoiceSend = audioCtx.createGain();
            delayVoiceSend.gain.value = currentParams.delay; 

            // Envelope: 8 second decay for sustain
            let initialGain = 0.3; 
            let envelopeTime = 8.0;

            masterVoiceGain.gain.setValueAtTime(0, now);
            masterVoiceGain.gain.linearRampToValueAtTime(initialGain, now + 0.005);
            masterVoiceGain.gain.exponentialRampToValueAtTime(0.0001, now + envelopeTime); 

            // --- AUDIO PATH CONNECTIONS ---
            masterVoiceGain.connect(dryGain);
            
            masterVoiceGain.connect(reverbVoiceSend);
            reverbVoiceSend.connect(globalReverb);

            masterVoiceGain.connect(delayVoiceSend);
            delayVoiceSend.connect(globalDelayL);
            delayVoiceSend.connect(globalDelayR);

            // --- Handpan Synthesis ---
            createPartial(freq, 1.0, 0.005, 5.0, masterVoiceGain, 'sine');
            createPartial(freq * 2.0, 0.5, 0.01, 3.5, masterVoiceGain, 'sine');
            createPartial(freq * 3.007, 0.35, 0.015, 2.5, masterVoiceGain, 'sine');
            createPartial(freq * 4.25, 0.1, 0.005, 0.5, masterVoiceGain, 'triangle');
            // -------------------------

            // Clean up voice nodes
            setTimeout(() => {
                try { 
                    masterVoiceGain.disconnect();
                    reverbVoiceSend.disconnect();
                    delayVoiceSend.disconnect();
                } catch(e){}
            }, envelopeTime * 1000 + 500);
        }

        // Helper function for creating partials
        function createPartial(baseFreq, amp, attack, decay, masterVoiceGain, type = 'sine') {
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            osc.type = type;
            osc.frequency.value = baseFreq;
            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(amp, now + attack);
            gain.gain.exponentialRampToValueAtTime(0.0001, now + decay);

            osc.connect(gain);
            gain.connect(masterVoiceGain); 
            osc.start(now);
            osc.stop(now + decay + 0.1);
        }
        
        // --- UI LOGIC ---
        function generateHandpanNotes(freqArray) {
            // Clear existing notes
            handpanVisual.innerHTML = '';
            
            // Use the note names from D Minor for display, regardless of actual scale
            const noteNames = NOTE_NAMES_D_MINOR; 

            const outerNotesData = freqArray.slice(1);
            
            // 1. Ding Note (Center)
            const dingEl = document.createElement('div');
            dingEl.className = 'note-field ding-note';
            dingEl.dataset.freq = freqArray[0];
            dingEl.dataset.noteIndex = 0;
            dingEl.textContent = noteNames[0]; 
            handpanVisual.appendChild(dingEl);

            const radius = 150;
            const center = 400 / 2;

            // 2. Outer Notes
            outerNotesData.forEach((freq, index) => {
                const angle = (index / outerNotesData.length) * 2 * Math.PI - (Math.PI / 2);
                const x = center + radius * Math.cos(angle);
                const y = center + radius * Math.sin(angle);
                
                const el = document.createElement('div');
                el.className = 'note-field outer-note';
                el.style.left = `${x - 35}px`;
                el.style.top = `${y - 35}px`; 
                el.dataset.freq = freq;
                el.dataset.noteIndex = index + 1;
                el.textContent = noteNames[index + 1];
                handpanVisual.appendChild(el);
            });

            // Re-apply event listeners to the new elements
            document.querySelectorAll('.note-field').forEach(el => {
                const handleInteractionStart = (e) => {
                    e.preventDefault();
                    if (!isAudioInitialized || !currentParams.power) return;
                    el.classList.add('active');
                    triggerNote(parseFloat(el.dataset.freq));
                };

                const handleInteractionEnd = (e) => {
                    e.preventDefault();
                    el.classList.remove('active');
                };

                el.addEventListener('mousedown', handleInteractionStart);
                el.addEventListener('touchstart', handleInteractionStart);
                el.addEventListener('mouseup', handleInteractionEnd);
                el.addEventListener('mouseleave', handleInteractionEnd);
                el.addEventListener('touchend', handleInteractionEnd);
                el.addEventListener('touchcancel', handleInteractionEnd);
            });
        }
        
        function initSliderInteractions() {
            Object.keys(sliders).forEach(key => {
                const slider = sliders[key];
                const display = sliderVals[key];

                slider.addEventListener('input', (e) => {
                    const newVal = parseFloat(e.target.value);
                    currentParams[key] = newVal;
                    display.textContent = newVal.toFixed(2);
                    
                    if (isAudioInitialized) {
                        updateMasterGains();
                        updateDelayParams(); 
                    }
                });
            });
        }
        
        function initScaleButtonInteractions() {
            document.querySelectorAll('.scale-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const newScaleIndex = parseInt(e.target.dataset.scaleIndex);
                    if (newScaleIndex === currentParams.scale) return; 

                    // Update UI
                    document.querySelectorAll('.scale-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');

                    // Update parameters and notes
                    currentParams.scale = newScaleIndex;
                    generateHandpanNotes(NOTE_FREQUENCIES[newScaleIndex]);
                });
            });
        }

        // --- UTILITY BUTTON LOGIC ---
        powerButton.addEventListener('click', async () => {
            if (!isAudioInitialized) return;

            if (currentParams.power) {
                // Power Off
                currentParams.power = false;
                powerButton.classList.remove('active');
                // Fade out volume before suspending
                masterGain.gain.setTargetAtTime(0.0001, audioCtx.currentTime, 0.05); 
                await audioCtx.suspend(); 
            } else {
                // Power On
                currentParams.power = true;
                powerButton.classList.add('active');
                await audioCtx.resume();
                // Fade back volume after resuming
                masterGain.gain.setTargetAtTime(currentParams.volume, audioCtx.currentTime, 0.1); 
            }
        });

        // Bluetooth button is non-functional placeholder
        document.getElementById('bluetooth-btn').addEventListener('click', (e) => {
            e.currentTarget.classList.toggle('active');
        });
    </script>
</body>
</html>
