<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Obsidian Pan v33 | Ultimate Safari Scroll Fix</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0d0d12;
            --panel-bg: #1c1c24;
            --pan-body-dark: #202028;
            --pan-body-light: #32323c;
            --note-field-base: rgba(0, 0, 0, 0.4);
            --note-text-color: #dddddd;
            --accent-blue: #00bcd4; /* Cyan/Teal (Primary Accent) */
            --accent-magenta: #cf4f9a; /* Deep Purple/Magenta (Secondary Accent) */
            --label-text: #999999;
            --shadow-light: rgba(255, 255, 255, 0.05);
            --shadow-dark: rgba(0, 0, 0, 0.8);
            --pan-size: 450px; 
            --control-width: 750px; 
        }

        /* --- CRITICAL SCROLL FIXES FOR SAFARI --- */
        html {
            height: 100%;
        }

        body {
            background-color: var(--bg-color);
            margin: 0;
            min-height: 100vh; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; 
            padding-top: 20px; 
            padding-bottom: 50px; 
            font-family: 'Poppins', sans-serif;
            
            /* The ultimate scroll guarantee for mobile devices */
            overflow-y: auto; 
            overflow-x: hidden; /* Prevent horizontal scrolling */
            
            touch-action: pan-y; /* Allow vertical touch scrolling */
            user-select: none;
            color: var(--label-text);
        }
        /* -------------------------------------- */


        /* --- START OVERLAY --- */
        #start-overlay {
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; font-size: 1.1rem;
            transition: opacity 0.5s ease-out;
        }
        #start-overlay h2 { margin-bottom: 30px; font-weight: 300; letter-spacing: 4px; color: var(--accent-blue); }
        #start-btn {
            background: var(--accent-blue); color: var(--bg-color);
            border: none; padding: 15px 30px; border-radius: 8px;
            font-family: inherit; font-size: 1rem; cursor: pointer;
            font-weight: 600;
            box-shadow: 0 0 15px rgba(0,188,212,0.4);
            transition: background 0.2s, box-shadow 0.2s;
        }

        /* --- MAIN CONTAINER --- */
        .pan-wrapper {
            display: flex; flex-direction: column; align-items: center;
            gap: 30px; 
            max-width: var(--control-width);
            width: 95%;
        }
        
        /* --- HANDPAN VISUAL (Enhanced 3D Look) --- */
        .handpan-container {
            position: relative;
            width: var(--pan-size);
            height: var(--pan-size);
            background: radial-gradient(circle at 35% 35%, var(--pan-body-light), var(--pan-body-dark) 80%);
            border-radius: 50%;
            box-shadow: 
                -10px -10px 30px var(--shadow-light), 
                10px 10px 30px var(--shadow-dark), 
                inset 0 0 80px rgba(0, 0, 0, 0.7);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
        }

        .note-field {
            position: absolute;
            background-color: var(--note-field-base);
            border-radius: 50%;
            box-shadow: 
                inset 5px 5px 10px var(--shadow-dark), 
                inset -5px -5px 10px var(--shadow-light);
            cursor: pointer;
            transition: transform 0.1s ease-out, box-shadow 0.1s ease-out;
            display: flex; justify-content: center; align-items: center;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--note-text-color);
            z-index: 10; 
        }
        .note-field.active {
            transform: scale(0.92);
            box-shadow: 
                inset 2px 2px 5px var(--shadow-dark), 
                inset -2px -2px 5px var(--shadow-light),
                0 0 15px var(--accent-blue);
        }
        .ding-note { width: 100px; height: 100px; }
        .outer-note { width: 70px; height: 70px; }


        /* --- CONTROL PANEL (Neumorphic Container) */
        .control-panel {
            background-color: var(--panel-bg);
            border-radius: 20px;
            padding: 20px 25px;
            box-shadow: 
                -8px -8px 15px var(--shadow-light), 
                8px 8px 15px var(--shadow-dark);
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
        }

        /* --- UTILITY BUTTONS (Color Theory Update) --- */
        .utility-buttons {
            display: flex;
            gap: 15px; 
            align-items: center;
        }
        .utility-btn {
            width: 40px; height: 40px; 
            border-radius: 12px;
            background: var(--panel-bg);
            color: var(--label-text); 
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
            box-shadow: 
                3px 3px 6px var(--shadow-dark), 
                -3px -3px 6px var(--shadow-light);
            transition: all 0.2s;
        }
        .utility-btn:active {
            box-shadow: 
                inset 2px 2px 5px var(--shadow-dark), 
                inset -2px -2px 5px var(--shadow-light);
            transform: scale(0.98);
        }

        /* Power Button Active: Matches Primary Accent (Teal) */
        .utility-btn.power.active { 
            color: var(--bg-color); 
            background: var(--accent-blue); 
            box-shadow: 0 0 15px var(--accent-blue); 
        }

        /* Surface Sound Button Active: Matches Secondary Accent (Magenta) */
        .utility-btn.surface.active {
            color: var(--bg-color);
            background: var(--accent-magenta); 
            box-shadow: 0 0 15px var(--accent-magenta); 
        }
        .utility-btn svg { width: 18px; height: 18px; fill: currentColor; }

        /* --- SLIDERS --- */
        .slider-group {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .slider-container { 
            display: flex; 
            flex-direction: column;
            gap: 8px;
            align-items: center;
            flex-grow: 1;
        }
        .slider-container label {
            font-size: 0.8rem; 
            color: var(--note-text-color);
            font-weight: 300;
        }
        .slider-label-value {
             color: var(--accent-blue);
             font-size: 0.9rem;
        }
        
        .control-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: #2a2a35; 
            border-radius: 3px;
            outline: none;
            box-shadow: inset 0 1px 3px var(--shadow-dark);
        }
        .control-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-blue);
            cursor: pointer;
            box-shadow: 0 0 8px var(--accent-blue);
        }

        /* --- SCALE BUTTONS --- */
        .scale-buttons-group { 
            display: flex;
            justify-content: space-around;
            gap: 12px;
            padding: 10px 0;
            flex-wrap: wrap; 
        }
        .scale-btn { 
            flex-basis: calc(33% - 8px); 
            padding: 10px 8px;
            border-radius: 10px;
            background: var(--panel-bg);
            color: var(--label-text);
            border: none;
            cursor: pointer;
            font-weight: 400;
            font-size: 0.8rem;
            text-align: center;
            box-shadow: 
                3px 3px 6px var(--shadow-dark), 
                -3px -3px 6px var(--shadow-light);
            transition: all 0.2s;
        }
        .scale-btn:active {
            box-shadow: 
                inset 2px 2px 5px var(--shadow-dark), 
                inset -2px -2px 5px var(--shadow-light);
            transform: scale(0.98);
        }
        .scale-btn.active {
            background: var(--accent-blue);
            color: var(--bg-color);
            font-weight: 600;
            box-shadow: 
                inset 2px 2px 5px var(--shadow-dark), 
                inset -2px -2px 5px var(--shadow-light),
                0 0 10px var(--accent-blue); 
        }
        
        h3 {
             color: var(--note-text-color); 
             font-weight: 600; 
             letter-spacing: 1px; 
             margin-bottom: 0;
        }

        /* --- RESPONSIVENESS (iPad and smaller devices) --- */
        @media (max-width: 768px) {
            :root {
                /* Even on 11inch iPad, the visible viewport height often makes 450px too tall. */
                --pan-size: 380px; 
                --control-width: 100%;
            }

            @media (min-width: 481px) and (max-width: 768px) {
                :root {
                    --pan-size: 400px; /* Slight bump for mid-size tablets, still allows space for controls */
                }
            }
            
            body { 
                padding-top: 10px;
                padding-bottom: 30px;
            }
            .pan-wrapper { gap: 20px; }
            .ding-note { width: 80px; height: 80px; }
            .outer-note { width: 60px; height: 60px; }
            .scale-btn {
                flex-basis: calc(50% - 8px); 
                font-size: 0.7rem;
            }
            .slider-group {
                flex-direction: column;
                gap: 10px;
            }
            .slider-container {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                width: 100%;
            }
            .control-slider {
                width: 50%;
                margin: 0;
            }
            .slider-container label { margin-right: 10px; }
            .control-panel { padding: 15px; }
        }
    </style>
</head>
<body>

    <div id="start-overlay">
        <h2>OBSIDIAN PAN v33</h2>
        <p style="font-weight: 300;">Ultimate Safari Scroll Fix Applied</p>
        <button id="start-btn">BEGIN SOUNDSCAPE</button>
    </div>

    <div class="pan-wrapper">
        
        <div class="control-panel">
            
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="utility-buttons">
                    <div class="utility-btn power" id="power-btn">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M13 3C13 2.44772 12.5523 2 12 2C11.4477 2 11 2.44772 11 3V11C11 11.5523 11.4477 12 12 12C12.5523 12 13 11.5523 13 11V3Z"/>
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20Z"/>
                        </svg>
                    </div>
                     <div class="utility-btn surface" id="surface-btn">
                         <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="5" fill="currentColor"/>
                         </svg>
                    </div>
                    <div class="utility-btn bluetooth" id="bluetooth-btn">
                         <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M7 17L17 7L12 2V22L17 17L7 7L12 12L7 17Z"/>
                        </svg>
                    </div>
                </div>
                <h3>AMBIENT MIXER</h3>
            </div>

            <div class="slider-group">
                <div class="slider-container">
                    <label for="volume-slider">MASTER VOLUME</label>
                    <input type="range" min="0" max="1" step="0.01" value="0.5" class="control-slider" id="volume-slider">
                    <span class="slider-label-value" id="volume-val">0.50</span>
                </div>
                <div class="slider-container">
                    <label for="reverb-slider">REVERB (SIZE)</label>
                    <input type="range" min="0" max="1" step="0.01" value="0.3" class="control-slider" id="reverb-slider">
                    <span class="slider-label-value" id="reverb-val">0.30</span>
                </div>
                <div class="slider-container">
                    <label for="width-slider">DIMENSION (DELAY)</label> 
                    <input type="range" min="0" max="1" step="0.01" value="0.0" class="control-slider" id="width-slider">
                    <span class="slider-label-value" id="width-val">0.00</span>
                </div>
            </div>


            <h3 style="text-align: center;">SCALE SELECTION</h3>
            <div class="scale-buttons-group" id="scale-selector">
                <button class="scale-btn active" data-scale-index="0">D Minor (Amara)</button>
                <button class="scale-btn" data-scale-index="1">C Major (Ionian)</button>
                <button class="scale-btn" data-scale-index="2">F Lydian (Dream)</button>
                <button class="scale-btn" data-scale-index="3">E Minor Pent.</button>
                <button class="scale-btn" data-scale-index="4">A Harmonic Minor</button>
                <button class="scale-btn" data-scale-index="5">D4 Solfeggio</button>
                <button class="scale-btn" data-scale-index="6">C4 Chakra Scale</button>
            </div>
        </div>
        
        <div class="handpan-container" id="handpan-visual">
        </div>
    </div>

    <script>
        // --- AUDIO CORE SETUP ---
        let audioCtx;
        let isAudioInitialized = false;
        let masterGain, masterCompressor, masterLimiter;
        let dryGain; 
        
        // REVERB & AMBIENCE NODES
        let globalReverb, globalReverbSend; 
        
        // DIMENSION/SUPERMASSIVE EFFECT NODES
        let dimensionDelay, dimensionLFO, dimensionFeedback, dimensionHPF, dimensionLimiter; 

        // --- CONSTANTS ---
        const MAX_DIMENSION_DELAY = 0.25; 
        const LFO_RATE = 0.2; 
        const MAX_FEEDBACK_GAIN = 0.60; 

        // --- DEFAULT PARAMETERS ---
        const DEFAULT_PARAMS = {
            volume: 0.5,
            reverb: 0.3, 
            dimension: 0.0, 
            scale: 0, 
            power: false,
            surfaceSound: true 
        };

        // --- UI & PARAMETERS ---
        const startButton = document.getElementById('start-btn');
        const powerButton = document.getElementById('power-btn');
        const surfaceButton = document.getElementById('surface-btn');
        const handpanVisual = document.getElementById('handpan-visual');

        const sliders = {
            volume: document.getElementById('volume-slider'),
            reverb: document.getElementById('reverb-slider'),
            dimension: document.getElementById('width-slider') 
        };
        const sliderVals = {
             volume: document.getElementById('volume-val'),
             reverb: document.getElementById('reverb-val'),
             dimension: document.getElementById('width-val') 
        };

        let currentParams = { ...DEFAULT_PARAMS }; 

        // --- SCALE DEFINITIONS ---
        const NOTE_FREQUENCIES = {
            0: [146.83, 220.00, 261.63, 293.66, 329.63, 349.23, 392.00, 440.00], // D Minor (Amara)
            1: [130.81, 196.00, 220.00, 261.63, 293.66, 329.63, 349.23, 392.00], // C Major (Ionian)
            2: [174.61, 261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88], // F Lydian (Dream)
            3: [164.81, 220.00, 246.94, 293.66, 329.63, 392.00, 440.00, 493.88], // E Minor Pent.
            4: [220.00, 261.63, 293.66, 329.63, 349.23, 415.30, 440.00, 493.88], // A Harmonic Minor
            5: [293.66, 349.23, 392.00, 417.00, 440.00, 528.00, 639.00, 741.00], // D4 Solfeggio (D4, F4, G4, Re, A4, Mi, Fa, Sol)
            6: [396.00, 417.00, 440.00, 528.00, 639.00, 741.00, 852.00, 963.00]  // C4 Chakra (Ut, Re, A4, Mi, Fa, Sol, La, Si)
        };
        
        // Note names are a compromise, mapping the note names to the first scale (D Minor) for UI consistency
        const NOTE_NAMES_D_MINOR = ["D3", "A3", "C4", "D4", "E4", "F4", "G4", "A4"];
        const NOTE_NAMES_CHAKRA = ["Root", "Sacral", "Solar", "Heart", "Throat", "3rd Eye", "Crown", "High"];

        
        // --- INITIALIZATION ---
        startButton.addEventListener('click', async () => {
            if (isAudioInitialized) return;
            
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                
                // RENAME UI LABEL 
                document.querySelector('.slider-container input#width-slider').parentNode.querySelector('label').textContent = 'DIMENSION (DELAY)';
                document.querySelector('.slider-container input#width-slider').parentNode.querySelector('.slider-label-value').id = 'dimension-val';
                
                await audioCtx.resume();
                
                initAudioGraph();
                initSliderInteractions();
                initScaleButtonInteractions();
                initUtilityButtonInteractions();
                
                generateHandpanNotes(NOTE_FREQUENCIES[DEFAULT_PARAMS.scale], NOTE_NAMES_D_MINOR); 
                initSurfaceHitHandler();

                isAudioInitialized = true; 
                resetUIAndParams(); 

                document.getElementById('start-overlay').style.opacity = 0;
                setTimeout(() => document.getElementById('start-overlay').style.display = 'none', 500);
            } catch (e) {
                alert("Audio failed to start. Error: " + e.message);
                console.error("Audio Init Error:", e);
            }
        });
        
        // Function to create a hard-clipping curve for WaveShaperNode
        function createHardClipCurve(amount = 0.8) {
            const n = 2048;
            const curve = new Float32Array(n);
            const half = n / 2;
            for (let i = 0; i < n; i++) {
                let x = (i - half) / half;
                if (x > amount) {
                    curve[i] = amount;
                } else if (x < -amount) {
                    curve[i] = -amount;
                } else {
                    curve[i] = x;
                }
            }
            return curve;
        }


        // --- AUDIO GRAPH SETUP ---
        function initAudioGraph() {
            // Master Gain & Limiting chain
            masterGain = audioCtx.createGain();
            masterGain.gain.value = currentParams.volume;
            masterCompressor = audioCtx.createDynamicsCompressor();
            masterLimiter = audioCtx.createDynamicsCompressor();
            masterLimiter.threshold.value = -3; 
            masterLimiter.ratio.value = 20; 
            
            masterGain.connect(masterCompressor).connect(masterLimiter).connect(audioCtx.destination);

            // DRY BUS (Mono foundation)
            dryGain = audioCtx.createGain(); 
            dryGain.connect(masterGain); 
            
            // REVERB BUS
            globalReverb = audioCtx.createConvolver();
            globalReverb.buffer = createReverbImpulse(5.0);
            globalReverbSend = audioCtx.createGain();
            globalReverbSend.gain.setValueAtTime(currentParams.reverb, audioCtx.currentTime);
            globalReverbSend.connect(globalReverb).connect(masterGain); 

            // --- DIMENSION (MODULATED DELAY) SETUP ---
            dimensionDelay = audioCtx.createDelay(MAX_DIMENSION_DELAY);
            dimensionFeedback = audioCtx.createGain(); 
            dimensionHPF = audioCtx.createBiquadFilter(); 
            dimensionHPF.type = 'highpass';
            dimensionHPF.frequency.value = 100; 

            // Hard Clipping WaveShaper for feedback loop safety
            dimensionLimiter = audioCtx.createWaveShaper(); 
            dimensionLimiter.curve = createHardClipCurve(0.8); 

            dimensionLFO = audioCtx.createOscillator(); 
            dimensionLFO.type = 'sine';
            dimensionLFO.frequency.value = LFO_RATE; 
            
            const lfoGain = audioCtx.createGain();
            lfoGain.gain.value = 0.0; 
            dimensionLFO.connect(lfoGain);
            dimensionLFO.start(0);
            
            dimensionLFO.gain = lfoGain.gain;
            
            // Routing: Dry Signal feeds the delay in parallel
            dryGain.connect(dimensionDelay);
            
            // Delay Output feeds Feedback Loop -> Limiter -> Filter -> Master Gain (Mix)
            dimensionDelay.connect(dimensionFeedback); 
            dimensionFeedback.connect(dimensionLimiter); 
            dimensionLimiter.connect(dimensionHPF).connect(masterGain); 

            // Feedback Loop: Filtered and limited signal feeds back into its input
            dimensionHPF.connect(dimensionDelay); 

            // LFO connects to the delay time parameter (modulation)
            lfoGain.connect(dimensionDelay.delayTime); 
        }

        function createReverbImpulse(duration) {
            const rate = audioCtx.sampleRate;
            const len = rate * duration;
            const buff = audioCtx.createBuffer(2, len, rate);
            for (let i = 0; i < len; i++) {
                const d = Math.pow(1 - i / len, 2.0);
                buff.getChannelData(0)[i] = (Math.random() * 2 - 1) * d * 0.4;
                buff.getChannelData(1)[i] = (Math.random() * 2 - 1) * d * 0.4;
            }
            return buff;
        }

        // --- UPDATE GAINS (RANGE CONSTRAINT) ---
        function updateMasterGains() {
            if (!isAudioInitialized) return;
            const now = audioCtx.currentTime;
            
            masterGain.gain.setTargetAtTime(currentParams.volume, now, 0.05);
            globalReverbSend.gain.setTargetAtTime(currentParams.reverb, now, 0.05);
            
            // --- Dimension (Modulated Delay) Control ---
            const dimVal = currentParams.dimension;

            // 1. Delay Time/Modulation Base: Base Delay is 50ms + up to 200ms
            dimensionDelay.delayTime.setTargetAtTime(0.05 + (dimVal * 0.20), now, 0.01);
            
            // 2. LFO Modulation Depth: Controls the shimmer/movement
            dimensionLFO.gain.setTargetAtTime(dimVal * 0.015, now, 0.05); 

            // 3. Feedback/Sustain: Capped at 0.60
            dimensionFeedback.gain.setTargetAtTime(dimVal * MAX_FEEDBACK_GAIN, now, 0.05); 
            
            // 4. HPF adjustment 
            dimensionHPF.frequency.setTargetAtTime(100 + (dimVal * 400), now, 0.05);
        }

        // --- SYNTHESIS ENGINE (NOTES) ---
        function triggerNote(freq, velocity, isEdgeHit) {
            if (!isAudioInitialized || !currentParams.power) return;
            const now = audioCtx.currentTime;

            const initialGain = 0.1 + (velocity * 0.4); 
            const envelopeTime = 8.0 + (velocity * 2.0); 

            const masterVoiceGain = audioCtx.createGain();
            masterVoiceGain.gain.setValueAtTime(0, now);
            masterVoiceGain.gain.linearRampToValueAtTime(initialGain, now + 0.005);
            masterVoiceGain.gain.exponentialRampToValueAtTime(0.0001, now + envelopeTime); 
            
            const reverbVoiceSend = audioCtx.createGain();
            reverbVoiceSend.gain.value = currentParams.reverb * velocity; 

            // Connections: Voice feeds Dry Gain AND Reverb Send
            masterVoiceGain.connect(dryGain);
            masterVoiceGain.connect(reverbVoiceSend).connect(globalReverbSend);
            
            // Handpan Synthesis (Additive FM)
            createPartial(freq, 1.0, 0.005, 5.0, masterVoiceGain, 'sine');
            createPartial(freq * 2.0, 0.5, 0.01, 3.5, masterVoiceGain, 'sine');
            createPartial(freq * 3.007, 0.35, 0.015, 2.5, masterVoiceGain, 'sine');
            createPartial(freq * 4.25, 0.1, 0.005, 0.5, masterVoiceGain, 'triangle');
            
            // Edge Hit Noise Feature
            if (isEdgeHit && currentParams.surfaceSound) {
                const noiseGain = audioCtx.createGain();
                noiseGain.gain.setValueAtTime(0, now);
                noiseGain.gain.linearRampToValueAtTime(0.3 * velocity, now + 0.001); 
                noiseGain.gain.exponentialRampToValueAtTime(0.0001, now + 0.5); 
                
                const noise = createNoiseBuffer(0.5); 
                const filter = audioCtx.createBiquadFilter();
                filter.type = 'highpass';
                filter.frequency.setValueAtTime(4000, now); 

                noise.connect(filter).connect(noiseGain).connect(dryGain);
                noise.start(now);
                noise.stop(now + 0.5);
            }

            // Cleanup
            setTimeout(() => {
                try { 
                    masterVoiceGain.disconnect();
                    reverbVoiceSend.disconnect();
                } catch(e){}
            }, envelopeTime * 1000 + 500);
        }

        // --- SYNTHESIS ENGINE (SURFACE) ---
        function triggerSurfaceSound(velocity) {
             if (!isAudioInitialized || !currentParams.power || !currentParams.surfaceSound) return; 
             const now = audioCtx.currentTime;
             
             const resonanceFreq = 80; 
             const initialGain = 0.05 + (velocity * 0.1); 
             const decayTime = 1.0 + (velocity * 0.5); 
             
             const bodyGain = audioCtx.createGain();
             bodyGain.gain.setValueAtTime(0, now);
             bodyGain.gain.linearRampToValueAtTime(initialGain, now + 0.01);
             bodyGain.gain.exponentialRampToValueAtTime(0.0001, now + decayTime);
             
             bodyGain.connect(dryGain);

             const osc = audioCtx.createOscillator();
             osc.type = 'sine';
             osc.frequency.setValueAtTime(resonanceFreq, now);

             const filter = audioCtx.createBiquadFilter();
             filter.type = 'bandpass';
             filter.frequency.setValueAtTime(resonanceFreq * 1.5, now);
             filter.Q.setValueAtTime(5, now);
             
             osc.connect(filter).connect(bodyGain);
             osc.start(now);
             osc.stop(now + decayTime + 0.1);
             
             const noiseGain = audioCtx.createGain();
             noiseGain.gain.setValueAtTime(0, now);
             noiseGain.gain.linearRampToValueAtTime(0.1 * velocity, now + 0.001);
             noiseGain.gain.exponentialRampToValueAtTime(0.0001, now + 0.2); 
             
             const noise = createNoiseBuffer(0.2);
             noise.connect(noiseGain).connect(dryGain);
             noise.start(now);
             noise.stop(now + 0.2);

             setTimeout(() => {
                 try {
                     bodyGain.disconnect();
                     osc.disconnect();
                     noiseGain.disconnect();
                     noise.disconnect();
                 } catch(e){}
             }, decayTime * 1000 + 500);
        }

        function createPartial(baseFreq, amp, attack, decay, masterVoiceGain, type = 'sine') {
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            osc.type = type;
            osc.frequency.value = baseFreq;
            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(amp, now + attack);
            gain.gain.exponentialRampToValueAtTime(0.0001, now + decay);

            osc.connect(gain);
            gain.connect(masterVoiceGain); 
            osc.start(now);
            osc.stop(now + decay + 0.1);
        }
        
        function createNoiseBuffer(duration) {
            const bufferSize = audioCtx.sampleRate * duration;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const output = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                output[i] = Math.random() * 2 - 1;
            }
            const source = audioCtx.createBufferSource();
            source.buffer = buffer;
            return source;
        }

        // --- HIT DETECTION & UI LOGIC ---
        function generateHandpanNotes(freqArray, namesArray) {
            handpanVisual.innerHTML = '';
            
            const outerNotesData = freqArray.slice(1);
            
            const style = getComputedStyle(handpanVisual);
            const containerWidthStr = style.getPropertyValue('--pan-size') || '450px';
            const containerWidth = parseFloat(containerWidthStr);
            
            const center = containerWidth / 2;
            const radius = center * 0.75; 

            // 1. Ding Note (Center)
            const dingEl = document.createElement('div');
            dingEl.className = 'note-field ding-note';
            dingEl.dataset.freq = freqArray[0];
            dingEl.dataset.noteIndex = 0;
            dingEl.textContent = namesArray[0]; 
            handpanVisual.appendChild(dingEl);
            const dingSize = 100;
            dingEl.style.left = `${center - dingSize / 2}px`;
            dingEl.style.top = `${center - dingSize / 2}px`;

            // 2. Outer Notes
            outerNotesData.forEach((freq, index) => {
                const angle = (index / outerNotesData.length) * 2 * Math.PI - (Math.PI / 2);
                const x = center + radius * Math.cos(angle);
                const y = center + radius * Math.sin(angle);
                
                const el = document.createElement('div');
                el.className = 'note-field outer-note';
                el.dataset.freq = freq;
                el.dataset.noteIndex = index + 1;
                el.textContent = namesArray[index + 1];
                handpanVisual.appendChild(el);
                
                const outerSize = 70;
                el.style.left = `${x - outerSize / 2}px`; 
                el.style.top = `${y - outerSize / 2}px`;  
            });

            document.querySelectorAll('.note-field').forEach(el => {
                el.addEventListener('mousedown', handleNoteInteractionStart);
                el.addEventListener('touchstart', handleNoteInteractionStart);
                el.addEventListener('mouseup', handleNoteInteractionEnd);
                el.addEventListener('mouseleave', handleNoteInteractionEnd);
                el.addEventListener('touchend', handleNoteInteractionEnd);
                el.addEventListener('touchcancel', handleNoteInteractionEnd);
            });
        }
        
        function initSurfaceHitHandler() {
            const handleSurfaceInteractionStart = (e) => {
                if (e.target.id !== 'handpan-visual') return; 

                e.preventDefault();
                if (!isAudioInitialized || !currentParams.power) return;

                let velocity = getVelocityFromEvent(e);
                triggerSurfaceSound(velocity);
            };

            handpanVisual.addEventListener('mousedown', handleSurfaceInteractionStart);
            handpanVisual.addEventListener('touchstart', handleSurfaceInteractionStart);
            handpanVisual.addEventListener('mouseup', handleNoteInteractionEnd); 
            handpanVisual.addEventListener('touchend', handleNoteInteractionEnd);
        }

        function handleNoteInteractionStart(e) {
            e.preventDefault();
            const el = this;

            if (!isAudioInitialized || !currentParams.power) return;
            el.classList.add('active');

            let velocity = getVelocityFromEvent(e);
            let clientX, clientY;
            
            if (e.type.startsWith('touch') && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            const hitData = getHitData(el, clientX, clientY);

            triggerNote(parseFloat(el.dataset.freq), velocity, hitData.isEdgeHit);
        }

        function handleNoteInteractionEnd(e) {
            e.preventDefault();
            const el = e.currentTarget.closest('.note-field') || (e.target.classList.contains('note-field') ? e.target : null); 
            if (el) {
                 el.classList.remove('active');
            }
        }

        function getVelocityFromEvent(e) {
            let velocity = 0.7; 
            if (e.type.startsWith('touch') && e.touches.length > 0) {
                const touch = e.touches[0];
                if (touch.force !== undefined) {
                    velocity = Math.max(0.1, Math.min(1.0, touch.force));
                }
            }
            return velocity;
        }

        function getHitData(noteElement, clientX, clientY) {
            const rect = noteElement.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const radius = rect.width / 2;
            const edgeThreshold = radius * 0.7; 

            const dx = clientX - centerX;
            const dy = clientY - centerY;
            const distance = Math.sqrt(dx * dx + dy * dy);

            const isEdgeHit = distance > edgeThreshold; 
            return { isEdgeHit, distance };
        }


        // --- CONTROL INTERACTIONS ---
        function initSliderInteractions() {
            Object.keys(sliders).forEach(key => {
                const slider = sliders[key];
                const display = sliderVals[key];

                slider.addEventListener('input', (e) => {
                    const newVal = parseFloat(e.target.value);
                    currentParams[key] = newVal; 
                    display.textContent = newVal.toFixed(2);
                    
                    if (isAudioInitialized) {
                        updateMasterGains();
                    }
                });
            });
        }
        
        function getScaleNames(scaleIndex) {
            if (scaleIndex === 6) {
                return NOTE_NAMES_CHAKRA;
            }
            // Use D Minor names for everything else for now 
            return NOTE_NAMES_D_MINOR;
        }

        function initScaleButtonInteractions() {
            document.querySelectorAll('.scale-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const newScaleIndex = parseInt(e.target.dataset.scaleIndex);
                    if (newScaleIndex === currentParams.scale) return; 

                    document.querySelectorAll('.scale-btn').forEach(b => b.classList.remove('active'));
                    document.querySelector(`.scale-btn[data-scale-index="${newScaleIndex}"]`).classList.add('active');

                    currentParams.scale = newScaleIndex;
                    const names = getScaleNames(newScaleIndex);
                    generateHandpanNotes(NOTE_FREQUENCIES[newScaleIndex], names);
                });
            });
        }
        
        function initUtilityButtonInteractions() {
            // Surface Sound Toggle
            surfaceButton.addEventListener('click', () => {
                currentParams.surfaceSound = !currentParams.surfaceSound;
                surfaceButton.classList.toggle('active', currentParams.surfaceSound);
            });

            // Bluetooth button is non-functional placeholder
            document.getElementById('bluetooth-btn').addEventListener('click', (e) => {
                e.currentTarget.classList.toggle('active');
            });
        }

        // --- UTILITY BUTTON LOGIC ---
        function resetUIAndParams() {
            currentParams = { ...DEFAULT_PARAMS };
            currentParams.power = true; 
            
            Object.keys(sliders).forEach(key => {
                sliders[key].value = DEFAULT_PARAMS[key];
                sliderVals[key].textContent = DEFAULT_PARAMS[key].toFixed(2);
            });
            
            document.querySelectorAll('.scale-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.scale-btn[data-scale-index="${DEFAULT_PARAMS.scale}"]`).classList.add('active');
            
            powerButton.classList.add('active');
            surfaceButton.classList.add('active');
            
            if (isAudioInitialized) {
                // Ensure audio is running and gains are set on reset
                audioCtx.resume();
                updateMasterGains(); 
            }
        }
        
        powerButton.addEventListener('click', async () => {
            if (!isAudioInitialized) return;

            if (currentParams.power) {
                // Powering OFF
                currentParams.power = false;
                powerButton.classList.remove('active');
                
                // 1. Fade out main volume
                masterGain.gain.setTargetAtTime(0.0001, audioCtx.currentTime, 0.1); 
                
                // 2. FIX: KILL THE FEEDBACK LOOP INSTANTLY
                dimensionFeedback.gain.setValueAtTime(0, audioCtx.currentTime); 
                
                // Set a short delay before suspension to allow the fade to finish
                setTimeout(async () => {
                    if (audioCtx.state !== 'suspended') {
                        await audioCtx.suspend(); 
                    }
                }, 150); 
                
            } else {
                // Powering ON
                currentParams.power = true;
                powerButton.classList.add('active');
                
                // Resume the context first
                if (audioCtx.state !== 'running') {
                    await audioCtx.resume();
                }
                // Then smoothly ramp up the gain to the stored volume
                masterGain.gain.setTargetAtTime(currentParams.volume, audioCtx.currentTime, 0.1); 
                // Restore feedback gain immediately to the current slider setting
                updateMasterGains();
            }
        });

        window.addEventListener('resize', () => {
            if (isAudioInitialized) {
                const names = getScaleNames(currentParams.scale);
                generateHandpanNotes(NOTE_FREQUENCIES[currentParams.scale], names);
            }
        });
    </script>
</body>
</html>
