<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow Planner v15 | iOS Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:ital,wght@0,400;0,700;1,400&family=Fira+Code:wght@300;400;600&family=Inter:wght@300;400;600&display=swap');
        
        :root { --bg: #282a36; --fg: #f8f8f2; --comment: #6272a4; --purple: #bd93f9; --green: #50fa7b; --current: #44475a; --red: #ff5555; --cyan: #8be9fd; }
        body { background-color: var(--bg); color: var(--fg); }
        
        .font-std { font-family: 'Inter', sans-serif; }
        .font-dyslexic { font-family: 'Atkinson Hyperlegible', sans-serif; letter-spacing: 0.03em; line-height: 1.6; }
        .font-mono { font-family: 'Fira Code', monospace; }

        .dracula-card { background-color: var(--current); border: 1px solid var(--comment); transition: all 0.3s ease; }
        
        .active-block { border-color: var(--purple); box-shadow: 0 0 25px rgba(189, 147, 249, 0.15); transform: scale(1.01); z-index: 10; opacity: 1 !important; filter: grayscale(0) !important; }
        .inactive-block { opacity: 0.4; filter: grayscale(0.8); }
        
        .editable-input { background: transparent; border: 1px solid transparent; width: 100%; transition: all 0.2s; }
        .edit-mode .editable-input { background: #191a21; border-color: var(--comment); border-radius: 4px; padding: 4px; }
        
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%; background: var(--purple); margin-top: -5px; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: var(--comment); border-radius: 2px; }

        .big-mode-overlay { position: fixed; inset: 0; background: #191a21; z-index: 100; padding: 40px; display: flex; flex-col; align-items: center; justify-content: center; }
        .big-text-cue { max-width: 90%; text-align: center; line-height: 1.5; white-space: pre-wrap; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden" x-data="app()" x-init="init()" :class="useDyslexicFont ? 'font-dyslexic' : 'font-std'">

    <!-- BIG MODE (Teacher View) -->
    <div x-show="bigMode" class="big-mode-overlay" x-transition.opacity style="display: none;">
        <button @click="bigMode=false" class="absolute top-4 right-4 text-[#6272a4] hover:text-white text-3xl"><i class="fa-solid fa-xmark"></i></button>
        <div x-show="isRunning && activeIndex < blocks.length" class="flex flex-col items-center w-full">
            <h1 class="text-[#bd93f9] font-bold mb-8 text-center" :style="`font-size: ${cueTextSize * 2.5}px`" x-text="blocks[activeIndex].title"></h1>
            <p class="big-text-cue text-[#f8f8f2]" :style="`font-size: ${cueTextSize * 2}px`" x-text="blocks[activeIndex].cue"></p>
            <div class="text-[#50fa7b] font-mono mt-12 font-bold" :style="`font-size: ${cueTextSize * 4}px`" x-text="formatTime(currentBlockTime)"></div>
            <button @click="skipBlock()" class="mt-12 px-8 py-4 bg-[#44475a] text-[#8be9fd] text-2xl font-bold rounded border border-[#6272a4] hover:bg-[#6272a4] hover:text-white transition">
                NEXT <i class="fa-solid fa-forward"></i>
            </button>
        </div>
        <div x-show="!isRunning" class="text-3xl text-gray-500">Paused</div>
    </div>

    <!-- HEADER -->
    <header class="bg-[#191a21] border-b border-[#6272a4] p-3 shadow-lg z-30 relative" x-show="!bigMode">
        <div class="flex justify-between items-center max-w-[98%] mx-auto w-full">
            
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-spa text-[#8be9fd] text-xl"></i>
                    <h1 class="font-bold text-lg tracking-wide text-[#f8f8f2]">FLOW <span class="text-[#ff79c6]">PLANNER</span></h1>
                </div>
                
                <!-- PRESETS & SHARE -->
                <div class="flex gap-2">
                    <!-- Preset Dropdown -->
                    <div class="relative" x-data="{open:false}">
                        <button @click="open=!open" class="bg-[#282a36] hover:bg-[#44475a] px-3 py-1 rounded text-xs text-[#f8f8f2] border border-[#6272a4] transition min-w-[160px] text-left flex justify-between items-center">
                            <span><i class="fa-solid fa-folder-open mr-2"></i> <span x-text="currentPresetName || 'Unsaved Session'"></span></span>
                            <i class="fa-solid fa-caret-down ml-2 text-[#6272a4]"></i>
                        </button>
                        <div x-show="open" @click.away="open=false" class="absolute top-full left-0 mt-1 w-72 bg-[#282a36] border border-[#6272a4] rounded shadow-xl z-50 p-2">
                            <div class="text-[10px] text-[#6272a4] uppercase font-bold mb-2 px-1">My Library</div>
                            <div class="max-h-48 overflow-y-auto custom-scroll mb-2">
                                <template x-for="(data, name) in savedPresets" :key="name">
                                    <div class="flex justify-between items-center hover:bg-[#44475a] p-1 rounded group">
                                        <button @click="loadPreset(name); open=false" class="text-xs text-left flex-1 text-[#f8f8f2]" x-text="name"></button>
                                        <button @click="deletePreset(name)" class="text-[#ff5555] opacity-0 group-hover:opacity-100 text-xs px-2"><i class="fa-solid fa-trash"></i></button>
                                    </div>
                                </template>
                                <div x-show="Object.keys(savedPresets).length === 0" class="text-xs text-[#6272a4] p-1 italic">No saved sessions.</div>
                            </div>
                            <div class="border-t border-[#6272a4] pt-2">
                                <input type="text" x-model="newPresetName" placeholder="Name this session..." class="w-full bg-[#191a21] text-[#f8f8f2] text-xs p-1.5 mb-1 border border-[#6272a4] rounded">
                                <button @click="savePreset(); open=false" class="w-full bg-[#50fa7b] text-[#282a36] text-xs font-bold py-1.5 rounded hover:bg-[#6bfb8e]">Save Session</button>
                            </div>
                        </div>
                    </div>

                    <!-- Share -->
                    <div class="relative" x-data="{open:false}">
                        <button @click="open=!open" class="bg-[#282a36] hover:bg-[#44475a] px-2 py-1 rounded text-xs text-[#8be9fd] border border-[#6272a4] transition" title="Share">
                            <i class="fa-solid fa-share-nodes"></i>
                        </button>
                        <div x-show="open" @click.away="open=false" class="absolute top-full left-0 mt-1 w-72 bg-[#282a36] border border-[#6272a4] rounded shadow-xl z-50 p-3">
                            <label class="text-[10px] uppercase text-[#6272a4] font-bold block mb-1">Share Current Flow</label>
                            <button @click="copyShareLink" class="w-full bg-[#44475a] hover:bg-[#6272a4] text-[#f8f8f2] text-xs py-2 rounded mb-3 border border-[#6272a4]">
                                <i class="fa-regular fa-copy mr-1"></i> Copy Code to Clipboard
                            </button>
                            <hr class="border-[#6272a4] mb-3">
                            <label class="text-[10px] uppercase text-[#6272a4] font-bold block mb-1">Load Shared Flow</label>
                            <textarea x-model="importString" class="w-full bg-[#191a21] text-[10px] text-[#f8f8f2] p-2 rounded border border-[#6272a4] mb-2 h-16" placeholder="Paste code here..."></textarea>
                            <button @click="loadFromShare" class="w-full bg-[#50fa7b] text-[#282a36] text-xs font-bold py-1.5 rounded hover:bg-[#6bfb8e]">Load</button>
                        </div>
                    </div>
                </div>

                <!-- SETTINGS -->
                <div class="relative" x-data="{open:false}">
                    <button @click="open=!open" class="text-[#6272a4] hover:text-[#f8f8f2] text-sm px-2"><i class="fa-solid fa-gear"></i></button>
                    <div x-show="open" @click.away="open=false" class="absolute top-full left-0 mt-1 w-64 bg-[#282a36] border border-[#6272a4] rounded shadow-xl z-50 p-4">
                         <div class="mb-4">
                            <label class="text-[10px] uppercase text-[#6272a4] font-bold block mb-2">Display</label>
                            <div class="flex items-center justify-between mb-3 bg-[#191a21] p-2 rounded border border-[#44475a]">
                                <span class="text-xs text-[#f8f8f2]">Dyslexic Font</span>
                                <button @click="useDyslexicFont = !useDyslexicFont" :class="useDyslexicFont ? 'bg-[#bd93f9]' : 'bg-[#44475a]'" class="w-8 h-4 rounded-full relative transition">
                                    <div :class="useDyslexicFont ? 'translate-x-4' : 'translate-x-0'" class="w-4 h-4 bg-white rounded-full shadow absolute top-0 left-0 transition-transform"></div>
                                </button>
                            </div>
                            <div class="bg-[#191a21] p-2 rounded border border-[#44475a]">
                                <div class="flex justify-between text-xs text-[#f8f8f2] mb-1">
                                    <span>Text Size</span>
                                    <span x-text="cueTextSize + 'px'" class="text-[#8be9fd] font-mono"></span>
                                </div>
                                <input type="range" min="14" max="32" step="1" x-model="cueTextSize" class="w-full">
                            </div>
                         </div>
                         <hr class="border-[#6272a4] mb-2">
                         <div class="space-y-1">
                             <button @click="exportJSON" class="w-full text-left text-xs py-2 px-2 hover:bg-[#44475a] text-[#8be9fd] rounded"><i class="fa-solid fa-file-export mr-2"></i> Backup (JSON)</button>
                             <div class="relative">
                                <input type="file" id="importFile" accept=".json" @change="importJSON" class="hidden">
                                <button onclick="document.getElementById('importFile').click()" class="w-full text-left text-xs py-2 px-2 hover:bg-[#44475a] text-[#50fa7b] rounded"><i class="fa-solid fa-file-import mr-2"></i> Restore (JSON)</button>
                            </div>
                         </div>
                    </div>
                </div>
            </div>

            <div class="text-center">
                <div class="text-3xl font-mono font-bold text-[#8be9fd]" x-text="formatTime(totalElapsed)">00:00</div>
            </div>

            <div class="flex items-center gap-3">
                <button @click="bigMode=true" class="text-[#f1fa8c] hover:text-white text-sm px-2" title="Big Mode"><i class="fa-solid fa-expand"></i></button>

                <div class="bg-[#282a36] rounded flex border border-[#6272a4] p-0.5">
                    <button @click="columns=1" :class="columns===1 ? 'bg-[#bd93f9] text-[#282a36]' : 'text-[#6272a4]'" class="px-2 py-1 rounded text-xs"><i class="fa-solid fa-list"></i></button>
                    <button @click="columns=2" :class="columns===2 ? 'bg-[#bd93f9] text-[#282a36]' : 'text-[#6272a4]'" class="px-2 py-1 rounded text-xs"><i class="fa-solid fa-border-all"></i></button>
                    <button @click="columns=3" :class="columns===3 ? 'bg-[#bd93f9] text-[#282a36]' : 'text-[#6272a4]'" class="px-2 py-1 rounded text-xs"><i class="fa-solid fa-table-columns"></i></button>
                </div>
                
                <button @click="toggleEditMode" class="px-3 py-1 rounded text-xs uppercase font-bold border border-[#6272a4]" 
                    :class="editMode ? 'bg-[#ff79c6] text-[#282a36]' : 'bg-[#282a36] text-[#f8f8f2]'">Edit</button>

                <button @click="togglePlay" class="px-6 py-1 rounded font-bold min-w-[100px]" 
                    :class="isRunning ? 'bg-[#ff5555] text-white' : 'bg-[#50fa7b] text-[#282a36]'">
                    <span x-text="isRunning ? 'STOP' : 'PLAY'"></span>
                </button>
            </div>
        </div>
        <div class="absolute bottom-0 left-0 w-full h-1 bg-[#191a21]">
            <div class="h-full bg-[#bd93f9] transition-all duration-1000 ease-linear" :style="`width: ${globalProgress}%`"></div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden" :class="editMode ? 'edit-mode' : ''" x-show="!bigMode">
        
        <!-- SIDEBAR -->
        <aside class="w-64 bg-[#21222c] border-r border-[#6272a4] flex flex-col overflow-y-auto z-20 shadow-xl shrink-0">
            <div class="p-4 border-b border-[#6272a4]">
                <h3 class="text-[10px] font-bold text-[#6272a4] uppercase mb-2">Atmosphere</h3>
                
                <!-- iOS-compatible file input -->
                <input type="file" 
                       id="bgmInput" 
                       accept="audio/mp3,audio/mpeg,audio/wav,audio/m4a,audio/aac,audio/ogg" 
                       @change="loadBGM($event)" 
                       class="hidden">
                
                <button @click="$refs.bgmInputTrigger.click()" 
                        x-ref="bgmInputTrigger"
                        onclick="document.getElementById('bgmInput').click()"
                        class="w-full bg-[#282a36] hover:bg-[#44475a] text-xs py-2 rounded mb-2 border border-[#6272a4] text-[#f8f8f2]">
                    <i class="fa-solid fa-music mr-2"></i> Load MP3
                </button>
                
                <div x-show="bgmLoaded" class="bg-[#191a21] p-2 rounded border border-[#6272a4] mt-2">
                    <div class="flex justify-between items-center text-xs text-[#8be9fd] mb-2">
                        <span class="truncate w-16" x-text="bgmName"></span>
                        <div class="flex items-center gap-1">
                            <button @click="toggleBGMLoop" class="text-[9px] px-1 py-0.5 rounded border"
                                    :class="bgmLoop ? 'text-[#50fa7b] border-[#50fa7b]' : 'text-[#6272a4] border-[#6272a4]'"
                                    title="Toggle Loop">
                                <i class="fa-solid fa-infinity"></i>
                            </button>
                            <button @click="bgmFadeOut" class="text-[#ff5555] hover:text-white text-[9px] border border-[#ff5555] px-1 rounded">FADE</button>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button @click="toggleBGMPlay" class="text-[#f8f8f2] hover:text-[#50fa7b] w-6">
                            <i class="fa-solid" :class="bgmPlaying ? 'fa-pause' : 'fa-play'"></i>
                        </button>
                        <input type="range" min="0" max="1" step="0.01" x-model="bgmVolume" @input="updateVolume" class="flex-1">
                    </div>
                    <audio id="bgmPlayer" class="hidden"></audio>
                </div>
            </div>
            <div class="p-4 flex-1">
                <h3 class="text-[10px] font-bold text-[#6272a4] uppercase mb-2">Sound Pad</h3>
                <div class="grid grid-cols-2 gap-2">
                    <button @mousedown="playSound('koshi_earth')" class="p-2 bg-[#282a36] hover:bg-[#ffb86c] hover:text-[#282a36] rounded text-xs border border-[#6272a4] text-[#ffb86c] transition">Earth</button>
                    <button @mousedown="playSound('koshi_fire')" class="p-2 bg-[#282a36] hover:bg-[#ff5555] hover:text-[#282a36] rounded text-xs border border-[#6272a4] text-[#ff5555] transition">Fire</button>
                    <button @mousedown="playSound('koshi_water')" class="p-2 bg-[#282a36] hover:bg-[#8be9fd] hover:text-[#282a36] rounded text-xs border border-[#6272a4] text-[#8be9fd] transition">Water</button>
                    <button @mousedown="playSound('koshi_air')" class="p-2 bg-[#282a36] hover:bg-[#f1fa8c] hover:text-[#282a36] rounded text-xs border border-[#6272a4] text-[#f1fa8c] transition">Air</button>
                    <button @mousedown="playSound('rainstick')" class="p-2 bg-[#282a36] hover:bg-[#50fa7b] hover:text-[#282a36] rounded text-xs border border-[#6272a4] text-[#50fa7b] transition">Rain</button>
                    <button @mousedown="playSound('ocean')" class="p-2 bg-[#282a36] hover:bg-[#bd93f9] hover:text-[#282a36] rounded text-xs border border-[#6272a4] text-[#bd93f9] transition">Ocean</button>
                    <button @mousedown="playSound('angel')" class="col-span-2 p-2 bg-[#282a36] hover:bg-[#f8f8f2] hover:text-[#282a36] rounded text-xs border border-[#6272a4] text-[#f8f8f2] font-bold">Angel Tuner</button>
                </div>
            </div>
        </aside>

        <!-- MAIN TIMELINE -->
        <main class="flex-1 overflow-y-auto p-6 bg-[#282a36] relative">
            <div id="timeline" class="grid gap-4 mx-auto pb-24 transition-all max-w-2xl"
                 :class="{ 'grid-cols-1': columns===1, '!max-w-5xl grid-cols-2': columns===2, '!max-w-7xl grid-cols-3': columns===3 }">
                
                <template x-for="(block, index) in blocks" :key="block.id">
                    <div :data-id="block.id" 
                         class="dracula-card rounded-lg p-3 relative flex flex-col gap-3 min-h-[160px]"
                         :class="{
                            'active-block': activeIndex === index && isRunning,
                            'inactive-block': !editMode && ((activeIndex !== index && isRunning) || (!isRunning && activeIndex !== index)),
                            'completed-block': !editMode && activeIndex > index && isRunning
                         }">
                        
                        <div x-show="editMode" class="bg-[#191a21] border-b border-[#6272a4] p-1 -mx-3 -mt-3 mb-2 rounded-t flex justify-end gap-2">
                             <div class="drag-handle cursor-grab text-[#6272a4] hover:text-white px-2 text-xs py-1"><i class="fa-solid fa-grip-vertical"></i> Move</div>
                             <button @click="removeBlock(index)" class="text-[#ff5555] hover:text-white px-2 text-xs border-l border-[#6272a4]"><i class="fa-solid fa-trash"></i> Del</button>
                        </div>

                        <div class="flex justify-between items-start border-b border-[#6272a4]/30 pb-2">
                            <div class="flex flex-col">
                                <div class="flex items-baseline gap-2">
                                    <span class="text-xl font-mono font-bold" 
                                          :class="activeIndex === index && isRunning ? 'text-[#50fa7b]' : 'text-[#f8f8f2]'">
                                        <span x-show="!editMode && activeIndex === index && isRunning" x-text="formatTime(currentBlockTime)"></span>
                                        <span x-show="editMode || activeIndex !== index || !isRunning" x-text="block.duration + 'm'"></span>
                                    </span>
                                    <input x-show="editMode" type="number" x-model="block.duration" class="w-12 text-xs bg-[#191a21] border border-[#6272a4] rounded text-center text-[#f8f8f2]">
                                </div>
                                <span class="text-[10px] text-[#6272a4] font-mono">@ <span x-text="formatTime(getAccumulatedTime(index))"></span></span>
                            </div>
                            
                            <div class="flex-1 pl-4 flex flex-col items-end">
                                <input x-model="block.title" :readonly="!editMode" 
                                       class="editable-input font-bold text-[#ff79c6] w-full text-right" 
                                       :style="`font-size: ${cueTextSize * 1.2}px`"
                                       placeholder="Title">
                                <button @click="toggleGong(index)" class="text-xs mt-1 px-2 py-0.5 rounded border" 
                                        :class="block.autoGong ? 'bg-[#ffb86c] text-[#282a36] border-[#ffb86c]' : 'text-[#6272a4] border-transparent'">
                                    <i class="fa-solid fa-bell"></i> <span x-text="block.autoGong ? 'Gong ON' : 'Gong OFF'"></span>
                                </button>
                            </div>
                        </div>

                        <div class="flex-1 flex flex-col gap-2">
                            <textarea x-model="block.cue" :readonly="!editMode" 
                                      class="editable-input editable-textarea text-[#f8f8f2] leading-relaxed p-1 w-full resize-none" 
                                      :style="`font-size: ${cueTextSize}px; min-height: ${cueTextSize * 4}px`"
                                      placeholder="Cues..."></textarea>
                            
                            <button x-show="isRunning && activeIndex === index" @click="skipBlock()" 
                                    class="w-full bg-[#44475a] hover:bg-[#6272a4] text-[#8be9fd] text-xs font-bold py-2 rounded mt-2 border border-[#6272a4] animate-pulse">
                                NEXT SEGMENT <i class="fa-solid fa-forward ml-1"></i>
                            </button>

                            <div class="flex flex-wrap gap-1 mt-auto pt-2">
                                <template x-for="inst in block.instruments">
                                    <button @click="playSound(getInstrumentCode(inst))" class="text-[9px] uppercase font-bold px-1.5 py-0.5 rounded border border-[#6272a4] text-[#8be9fd] hover:bg-[#8be9fd] hover:text-[#282a36] transition"><span x-text="inst"></span></button>
                                </template>
                                <button x-show="editMode" @click="addInstrumentPrompt(index)" class="text-[10px] px-2 border border-dashed border-[#6272a4] text-[#6272a4] rounded hover:text-white">+</button>
                            </div>
                        </div>
                    </div>
                </template>

                <button x-show="editMode" @click="addBlock" class="min-h-[160px] border-2 border-dashed border-[#44475a] rounded-lg flex flex-col items-center justify-center text-[#6272a4] hover:border-[#bd93f9] hover:text-[#bd93f9] transition">
                    <i class="fa-solid fa-plus text-2xl mb-1"></i> <span class="text-xs font-bold">ADD SEGMENT</span>
                </button>
            </div>
        </main>
    </div>

    <script>
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const ctx = new AudioContext();

        function app() {
            return {
                isRunning: false, editMode: false, columns: 3, bigMode: false,
                totalElapsed: 0, activeIndex: 0, currentBlockTime: 0, timerInterval: null, globalProgress: 0,
                bgmLoaded: false, bgmName: '', bgmPlaying: false, bgmVolume: 0.5, bgmLoop: true,
                useDyslexicFont: false, cueTextSize: 14,
                importString: '', savedPresets: {}, currentPresetName: '', newPresetName: '', blocks: [],

                init() {
                    const presetDB = localStorage.getItem('flowPlannerPresets_v15');
                    if(presetDB) this.savedPresets = JSON.parse(presetDB);
                    const activeSession = localStorage.getItem('flowPlannerActive_v15');
                    if(activeSession) this.blocks = JSON.parse(activeSession); 
                    else this.blocks = [{id:1, title:"Arrival", duration:5, cue:"Welcome.", instruments:["Ocean Drum"], autoGong:false}];
                    const settings = localStorage.getItem('flowPlannerSettings_v15');
                    if(settings) { const s = JSON.parse(settings); this.useDyslexicFont = s.dyslexic; this.cueTextSize = s.size; }

                    this.$watch('blocks', (val) => localStorage.setItem('flowPlannerActive_v15', JSON.stringify(val)));
                    this.$watch('cueTextSize', () => this.saveSettings());
                    this.$watch('useDyslexicFont', () => this.saveSettings());
                    
                    this.$nextTick(() => {
                        new Sortable(document.getElementById('timeline'), {
                            handle: '.drag-handle', animation: 150,
                            onEnd: (evt) => {
                                const item = this.blocks.splice(evt.oldIndex, 1)[0];
                                this.blocks.splice(evt.newIndex, 0, item);
                            }
                        });
                    });
                },
                saveSettings() {
                    localStorage.setItem('flowPlannerSettings_v15', JSON.stringify({ dyslexic: this.useDyslexicFont, size: this.cueTextSize }));
                },

                // PRESETS
                savePreset() { 
                    if(!this.newPresetName) return; 
                    this.savedPresets = { ...this.savedPresets, [this.newPresetName]: JSON.parse(JSON.stringify(this.blocks)) };
                    localStorage.setItem('flowPlannerPresets_v15', JSON.stringify(this.savedPresets)); 
                    this.currentPresetName = this.newPresetName; 
                    this.newPresetName = ''; 
                },
                loadPreset(name) { 
                    if(this.savedPresets[name]) { 
                        this.blocks = JSON.parse(JSON.stringify(this.savedPresets[name])); 
                        this.currentPresetName = name; 
                        this.resetTimer(); 
                    } 
                },
                deletePreset(name) { 
                    if(confirm(`Delete ${name}?`)) { 
                        const newPresets = {...this.savedPresets};
                        delete newPresets[name];
                        this.savedPresets = newPresets;
                        localStorage.setItem('flowPlannerPresets_v15', JSON.stringify(this.savedPresets)); 
                        if(this.currentPresetName === name) this.currentPresetName = ''; 
                    } 
                },

                // EXPORT / IMPORT
                exportJSON() { 
                    const backup = { presets: this.savedPresets, current: this.blocks };
                    const url = URL.createObjectURL(new Blob([JSON.stringify(backup, null, 2)], {type: 'application/json'}));
                    const a = document.createElement('a'); a.href = url; a.download = 'flow_planner_backup.json'; a.click(); 
                },
                importJSON(e) { 
                    const f = e.target.files[0]; if(!f) return; 
                    const r = new FileReader(); 
                    r.onload = (ev) => { 
                        try { 
                            const d = JSON.parse(ev.target.result); 
                            if(d.presets) this.savedPresets = {...this.savedPresets, ...d.presets}; 
                            if(d.current) this.blocks = d.current; 
                            localStorage.setItem('flowPlannerPresets_v15', JSON.stringify(this.savedPresets)); 
                            alert("Backup restored."); 
                        } catch(err) { alert("Invalid JSON"); } 
                    }; 
                    r.readAsText(f); 
                },

                // SHARE
                copyShareLink() {
                    const str = btoa(JSON.stringify(this.blocks));
                    navigator.clipboard.writeText(str).then(() => alert("Copied code to clipboard."));
                },
                loadFromShare() {
                    try {
                        const json = atob(this.importString.trim());
                        this.blocks = JSON.parse(json);
                        this.importString = '';
                        alert("Shared flow loaded.");
                    } catch(e) { alert("Invalid code"); }
                },

                // AUDIO - iOS FIX
                loadBGM(e) { 
                    const f = e.target.files[0]; 
                    if(!f) return; 
                    this.bgmName = f.name; 
                    const p = document.getElementById('bgmPlayer');
                    
                    // iOS Safari needs createObjectURL
                    const url = URL.createObjectURL(f);
                    p.src = url;
                    p.loop = this.bgmLoop;
                    this.bgmLoaded = true;
                    
                    // Force load on iOS
                    p.load();
                },
                toggleBGMPlay() { 
                    const p = document.getElementById('bgmPlayer'); 
                    if(this.bgmPlaying) {
                        p.pause();
                    } else {
                        // iOS requires user gesture - this is triggered by click
                        p.play().catch(err => {
                            console.error('Play failed:', err);
                            alert('Please tap the play button again.');
                        });
                    }
                    this.bgmPlaying = !this.bgmPlaying; 
                },
                updateVolume() { document.getElementById('bgmPlayer').volume = this.bgmVolume; },
                toggleBGMLoop() {
                    const p = document.getElementById('bgmPlayer');
                    this.bgmLoop = !this.bgmLoop;
                    p.loop = this.bgmLoop;
                },
                bgmFadeOut() { 
                    const p = document.getElementById('bgmPlayer'); 
                    const fade = setInterval(() => { 
                        if(p.volume > 0.05) { p.volume -= 0.05; this.bgmVolume = p.volume; } 
                        else { p.volume = 0; this.bgmVolume = 0; p.pause(); this.bgmPlaying = false; clearInterval(fade); } 
                    }, 250); 
                },
                playSound(type) {
                    if(ctx.state === 'suspended') ctx.resume();
                    const synth = (freq, vol, sus) => {
                        const o = ctx.createOscillator(); const g = ctx.createGain();
                        o.frequency.value = freq; o.connect(g); g.connect(ctx.destination);
                        o.start(); g.gain.setValueAtTime(0, ctx.currentTime);
                        g.gain.linearRampToValueAtTime(vol, ctx.currentTime+0.05);
                        g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + (sus?4:2));
                        o.stop(ctx.currentTime + (sus?4:2));
                    };
                    if(type.startsWith('koshi')) { 
                        const s = {'koshi_earth':[392,523,659], 'koshi_fire':[392,493,587], 'koshi_water':[440,587,698], 'koshi_air':[440,523,659]}; 
                        s[type].forEach((n,i) => setTimeout(()=>synth(n, 0.1, true), i*120)); 
                    } else if(type==='angel') { 
                        synth(4096, 0.05, true); 
                        synth(4160, 0.05, true); 
                    } else {
                        const b = ctx.createBuffer(1,ctx.sampleRate*2,ctx.sampleRate); 
                        const d = b.getChannelData(0); 
                        for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
                        const n = ctx.createBufferSource(); n.buffer=b; 
                        const f = ctx.createBiquadFilter(); 
                        f.type = type==='ocean' ? 'lowpass' : 'highpass'; 
                        f.frequency.value = type==='ocean' ? 300 : 800;
                        const g = ctx.createGain(); 
                        n.connect(f); f.connect(g); g.connect(ctx.destination); 
                        n.start(); 
                        g.gain.setValueAtTime(0.05, ctx.currentTime); 
                        g.gain.linearRampToValueAtTime(0, ctx.currentTime+2);
                    }
                },
                playGong() { 
                    if(ctx.state === 'suspended') ctx.resume(); 
                    const o = ctx.createOscillator(); const g = ctx.createGain(); 
                    o.frequency.value = 220; o.connect(g); g.connect(ctx.destination); 
                    o.start(); g.gain.setValueAtTime(0, ctx.currentTime); 
                    g.gain.linearRampToValueAtTime(0.2, ctx.currentTime+0.05); 
                    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 3); 
                    o.stop(ctx.currentTime + 3); 
                },
                getInstrumentCode(n) { 
                    if(n.includes("Earth")) return 'koshi_earth'; 
                    if(n.includes("Fire")) return 'koshi_fire'; 
                    if(n.includes("Water")) return 'koshi_water'; 
                    if(n.includes("Air")) return 'koshi_air'; 
                    if(n.includes("Rain")) return 'rainstick'; 
                    if(n.includes("Ocean")) return 'ocean'; 
                    if(n.includes("Angel")) return 'angel'; 
                    return ''; 
                },

                // CORE FLOW
                togglePlay() { 
                    if(this.isRunning) { clearInterval(this.timerInterval); this.isRunning=false; } 
                    else { 
                        this.isRunning=true; 
                        if(this.currentBlockTime===0) this.currentBlockTime = this.blocks[this.activeIndex].duration*60; 
                        this.timerInterval = setInterval(()=>this.tick(), 1000); 
                    } 
                },
                tick() {
                    this.totalElapsed++;
                    const totalDur = this.blocks.reduce((a,b)=>a+(b.duration*60),0);
                    let done = 0; 
                    for(let i=0;i<this.activeIndex;i++) done+=(this.blocks[i].duration*60);
                    this.globalProgress = ((done + (this.blocks[this.activeIndex].duration*60 - this.currentBlockTime)) / totalDur) * 100;
                    if(this.currentBlockTime === 10 && this.blocks[this.activeIndex].autoGong) { this.playGong(); }
                    if(this.currentBlockTime>0) this.currentBlockTime--;
                    else if(this.activeIndex<this.blocks.length-1) { 
                        this.activeIndex++; 
                        this.currentBlockTime = this.blocks[this.activeIndex].duration*60; 
                    } else { 
                        this.isRunning=false; 
                        clearInterval(this.timerInterval); 
                        alert("Flow Complete"); 
                    }
                },
                skipBlock() { 
                    if(this.activeIndex < this.blocks.length - 1) { 
                        this.currentBlockTime = 0; 
                        this.tick(); 
                    } else { 
                        this.isRunning = false; 
                        clearInterval(this.timerInterval); 
                        alert("Session Finished Early"); 
                    } 
                },
                resetTimer() { 
                    this.isRunning=false; 
                    clearInterval(this.timerInterval); 
                    this.totalElapsed=0; 
                    this.activeIndex=0; 
                    this.currentBlockTime=0; 
                    this.globalProgress=0; 
                },
                getAccumulatedTime(idx) { 
                    let s=0; 
                    for(let i=0; i<idx; i++) s+=this.blocks[i].duration*60; 
                    return s; 
                },
                formatTime(s) { 
                    const m=Math.floor(s/60).toString().padStart(2,'0'); 
                    const sc=(s%60).toString().padStart(2,'0'); 
                    return `${m}:${sc}`; 
                },
                addBlock() { this.blocks.push({id:Date.now(), title:"New Segment", duration:5, cue:"", instruments:[], autoGong:false}); },
                removeBlock(i) { this.blocks.splice(i,1); },
                toggleEditMode() { this.editMode=!this.editMode; },
                toggleGong(i) { this.blocks[i].autoGong = !this.blocks[i].autoGong; },
                addInstrumentPrompt(i) { 
                    const o=prompt("Add: Koshi Earth/Fire/Water/Air, Rainstick, Ocean, Angel"); 
                    if(o) this.blocks[i].instruments.push(o); 
                }
            }
        }
    </script>
</body>
</html>
